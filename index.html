<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Driver SMS">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23667eea'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>üí¨</text></svg>">
    <title>Driver SMS Manager</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%234F46E5%22/><circle cx=%2250%22 cy=%2250%22 r=%2235%22 stroke=%22white%22 stroke-width=%228%22 fill=%22none%22/><circle cx=%2250%22 cy=%2250%22 r=%2210%22 fill=%22white%22/><path d=%22M50 50 L50 15 M50 50 L20 70 M50 50 L80 70%22 stroke=%22white%22 stroke-width=%228%22 stroke-linecap=%22round%22/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --gradient-start: #667eea;
            --gradient-end: #764ba2;
            --primary: #667eea;
            --primary-dark: #5568d3;
            --primary-light: #8b9cfc;
            --primary-lighter: #c7d2fe;
        }

        [data-theme="purple"] {
            --gradient-start: #667eea;
            --gradient-end: #764ba2;
            --primary: #667eea;
            --primary-dark: #5568d3;
            --primary-light: #8b9cfc;
            --primary-lighter: #c7d2fe;
        }

        [data-theme="blue"] {
            --gradient-start: #4facfe;
            --gradient-end: #00f2fe;
            --primary: #4facfe;
            --primary-dark: #3d8fd9;
            --primary-light: #7ec4ff;
            --primary-lighter: #b3dbff;
        }

        [data-theme="green"] {
            --gradient-start: #43e97b;
            --gradient-end: #38f9d7;
            --primary: #43e97b;
            --primary-dark: #37c767;
            --primary-light: #6ef09a;
            --primary-lighter: #a8f5c3;
        }

        [data-theme="orange"] {
            --gradient-start: #fa709a;
            --gradient-end: #fee140;
            --primary: #fa709a;
            --primary-dark: #e35d87;
            --primary-light: #fb93b2;
            --primary-lighter: #fcc8d5;
        }

        [data-theme="pink"] {
            --gradient-start: #f093fb;
            --gradient-end: #f5576c;
            --primary: #f093fb;
            --primary-dark: #d97fe6;
            --primary-light: #f5b1fc;
            --primary-lighter: #f9d4fd;
        }

        [data-theme="dark"] {
            --gradient-start: #2c3e50;
            --gradient-end: #3498db;
            --primary: #3498db;
            --primary-dark: #2980b9;
            --primary-light: #5dade2;
            --primary-lighter: #aed6f1;
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .modern-button {
            transition: all 0.3s ease;
        }

        .modern-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .driver-card {
            transition: all 0.3s ease;
        }

        .driver-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .bg-primary {
            background-color: var(--primary) !important;
        }

        .bg-primary-dark {
            background-color: var(--primary-dark) !important;
        }

        .bg-primary-light {
            background-color: var(--primary-light) !important;
        }

        .bg-primary-lighter {
            background-color: var(--primary-lighter) !important;
        }

        .text-primary {
            color: var(--primary) !important;
        }

        .text-primary-dark {
            color: var(--primary-dark) !important;
        }

        .border-primary {
            border-color: var(--primary) !important;
        }

        .border-primary-light {
            border-color: var(--primary-light) !important;
        }

        .hover-primary:hover {
            background-color: var(--primary-dark) !important;
        }
    </style>
</head>

<body class="p-6 relative">
    <!-- Demo Banner -->
    <div
        class="fixed top-0 left-0 w-full bg-yellow-400 text-yellow-900 text-center text-xs font-bold py-1 z-50 shadow-md">
        ‚ö†Ô∏è DEMO MODE - No real messages will be sent
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- Login Screen -->
        <div id="loginScreen" class="glass-card rounded-2xl p-8 max-w-md mx-auto">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üë•</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Driver SMS Manager</h1>
                <p class="text-gray-600">Select your profile to continue</p>
                <p class="text-xs text-gray-400 mt-2">v2.2.0</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                    <input type="text" id="usernameInput"
                        class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-indigo-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input type="password" id="passwordInput"
                        class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-indigo-500 focus:outline-none"
                        onkeypress="if(event.key==='Enter') login()">
                </div>

                <button onclick="login()"
                    class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                    Login & Start Messaging
                </button>

                <p class="text-xs text-center text-gray-400">
                    First time? Use <b>admin</b> / <b>admin</b> to setup.
                </p>
            </div>

        </div>

        <!-- User Management Modal -->
        <div id="userManagementModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="glass-card rounded-2xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">üë• User Management</h2>

                <!-- Add New User -->
                <div class="bg-indigo-50 border-2 border-indigo-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4" id="formTitle">Add New User</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                            <input type="text" id="newUserName" placeholder="e.g., jamie"
                                class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 focus:border-indigo-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                            <input type="text" id="newUserPass" placeholder="e.g., secret123"
                                class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 focus:border-indigo-500 focus:outline-none">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Role</label>
                            <select id="newUserRole"
                                class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 focus:border-indigo-500 focus:outline-none">
                                <option value="User">User</option>
                                <option value="Dispatcher">Dispatcher</option>
                                <option value="Manager">Manager</option>
                                <option value="Director">Director</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Color</label>
                            <div class="flex flex-wrap gap-3" id="colorPalette">
                                <!-- Preset Colors -->
                                <button onclick="selectColor(this, '#667eea')"
                                    class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition ring-2 ring-offset-2 ring-indigo-500"
                                    style="background-color: #667eea;" data-color="#667eea"></button>
                                <button onclick="selectColor(this, '#ed64a6')"
                                    class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition"
                                    style="background-color: #ed64a6;" data-color="#ed64a6"></button>
                                <button onclick="selectColor(this, '#48bb78')"
                                    class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition"
                                    style="background-color: #48bb78;" data-color="#48bb78"></button>
                                <button onclick="selectColor(this, '#ecc94b')"
                                    class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition"
                                    style="background-color: #ecc94b;" data-color="#ecc94b"></button>
                                <button onclick="selectColor(this, '#f56565')"
                                    class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition"
                                    style="background-color: #f56565;" data-color="#f56565"></button>
                                <button onclick="selectColor(this, '#ed8936')"
                                    class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition"
                                    style="background-color: #ed8936;" data-color="#ed8936"></button>
                                <button onclick="selectColor(this, '#4299e1')"
                                    class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition"
                                    style="background-color: #4299e1;" data-color="#4299e1"></button>
                                <button onclick="selectColor(this, '#9f7aea')"
                                    class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition"
                                    style="background-color: #9f7aea;" data-color="#9f7aea"></button>
                                <button onclick="selectColor(this, '#38b2ac')"
                                    class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition"
                                    style="background-color: #38b2ac;" data-color="#38b2ac"></button>
                                <button onclick="selectColor(this, '#718096')"
                                    class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition"
                                    style="background-color: #718096;" data-color="#718096"></button>
                            </div>
                            <input type="hidden" id="newUserColor" value="#667eea">
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="addUserBtn" onclick="addUser()"
                        class="mt-4 flex-1 bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">
                        ‚ûï Add User
                    </button>
                    <button id="cancelEditBtn" onclick="resetUserForm()"
                        class="mt-4 w-24 bg-gray-400 text-white py-2 rounded-lg font-semibold hover:bg-gray-500 transition hidden">
                        Cancel
                    </button>
                </div>
            </div>

            <!-- User List -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Current Users</h3>
                <div id="userList" class="space-y-2">
                    <p class="text-center text-gray-500 text-sm py-8">Loading...</p>
                </div>
            </div>

            <div class="flex gap-4 mt-6">
                <button onclick="closeUserManagement()"
                    class="flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <div class="glass-card rounded-2xl p-6 mb-6 flex items-center justify-between">
            <div>
                <h1 id="appHeaderTitle" class="text-3xl font-bold text-gray-800">üí¨ Driver SMS Manager <span
                        class="text-sm text-gray-400">v2.2.0</span></h1>
                <p class="text-gray-600 mt-1">Send bulk messages to your delivery team</p>
                <p class="text-sm text-gray-500 mt-1">üë§ Logged in as: <span id="currentUserDisplay"
                        class="font-semibold"></span></p>
            </div>
            <div class="flex gap-2">
                <button id="manageUsersBtn" onclick="showUserManagement()"
                    class="modern-button px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 hidden">
                    üë• Users
                </button>
                <a href="guide.html" target="_blank"
                    class="modern-button px-6 py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 decoration-0 no-underline flex items-center gap-2">
                    üìö Guide
                </a>
                <button onclick="showSettings()"
                    class="modern-button px-6 py-3 bg-gray-700 text-white rounded-xl font-semibold hover:bg-gray-800">
                    ‚öôÔ∏è Settings
                </button>
                <button onclick="logout()"
                    class="modern-button px-6 py-3 bg-red-600 text-white rounded-xl font-semibold hover:bg-red-700">
                    üö™ Logout
                </button>
            </div>
        </div>

        <!-- Upload Prompt (shows when no drivers loaded) -->
        <div id="uploadPrompt" class="glass-card rounded-2xl p-8 text-center">
            <div class="text-6xl mb-4">üìã</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Get Started</h2>
            <p class="text-gray-600 mb-6">Upload your driver list to begin</p>

            <div class="border-2 border-dashed rounded-2xl p-8 hover:border-primary transition inline-block"
                style="border-color: var(--primary-light); background-color: rgba(var(--primary-rgb), 0.05);">
                <label class="cursor-pointer">
                    <span class="text-lg font-semibold text-primary hover-primary">
                        üìÅ Choose Excel File
                    </span>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden" onchange="handleFileUpload()">
                </label>
            </div>
        </div>

        <!-- Main Interface (hidden until drivers loaded) -->
        <div id="mainInterface" class="hidden">
            <div class="flex gap-6" style="height: calc(100vh - 200px);">
                <!-- Left Column - Teams & Drivers -->
                <div class="w-96 flex flex-col gap-4">
                    <!-- Team Selection with Sort -->
                    <div class="glass-card rounded-2xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-lg font-bold text-gray-800">üéØ Team</h2>
                            <div class="flex gap-1">
                                <button onclick="sortDrivers('recent')" id="sortRecentBtn"
                                    class="modern-button px-2 py-1 bg-indigo-600 text-white rounded text-xs">
                                    Recent
                                </button>
                                <button onclick="sortDrivers('myRecent')" id="sortMyRecentBtn"
                                    class="modern-button px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs"
                                    title="Show drivers I messaged recently">
                                    My Recent
                                </button>
                                <button onclick="sortDrivers('name')" id="sortNameBtn"
                                    class="modern-button px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs">
                                    Name
                                </button>
                                <button onclick="sortDrivers('team')" id="sortTeamBtn"
                                    class="modern-button px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs">
                                    Team
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <label class="flex items-center gap-2 text-xs font-semibold text-gray-600 cursor-pointer">
                                <input type="checkbox" id="hideBulkToggle"
                                    onchange="displayMessages(); updateDriverList();"
                                    class="rounded text-primary focus:ring-primary">
                                Hide Bulk Messages
                            </label>
                        </div>
                        <select id="teamSelect" onchange="updateDriverList()"
                            class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm font-semibold">
                        </select>
                    </div>

                    <!-- Bulk Message Button -->
                    <button onclick="showBulkModal()"
                        class="modern-button w-full px-4 py-3 bg-primary text-white rounded-xl font-semibold hover-primary">
                        üì§ Send Bulk Message
                    </button>

                    <!-- New Message Button -->
                    <button onclick="showNewMessageModal()"
                        class="modern-button w-full px-4 py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700">
                        ‚ûï New Message
                    </button>

                    <!-- Search Box -->
                    <div class="glass-card rounded-2xl p-2 relative">
                        <input type="text" id="driverSearch" placeholder="üîç Search drivers..."
                            class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg text-sm focus:border-indigo-500 focus:outline-none pr-10"
                            oninput="handleSearch()">
                        <button id="clearSearchBtn" onclick="clearSearch()"
                            class="hidden absolute right-3 top-1/2 transform -translate-y-1/2 w-6 h-6 rounded-full bg-gray-300 hover:bg-gray-400 text-gray-700 hover:text-white transition-all duration-200 flex items-center justify-center text-xs font-bold">
                            ‚úï
                        </button>
                    </div>

                    <!-- Drivers List -->
                    <div class="glass-card rounded-2xl p-4 flex-1 overflow-hidden flex flex-col">
                        <h2 class="text-lg font-bold text-gray-800 mb-3">üë• Drivers</h2>
                        <div id="driverList" class="space-y-2 overflow-y-auto flex-1"></div>
                    </div>
                </div>

                <!-- Right Column - Conversation & Results -->
                <div class="flex-1 flex flex-col gap-4 overflow-hidden">
                    <!-- Conversation View -->
                    <div id="conversationView"
                        class="glass-card rounded-2xl p-6 flex-1 flex-col overflow-hidden hidden">
                        <div class="flex justify-between items-center mb-4 pb-4 border-b-2 flex-shrink-0">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800" id="convName"></h2>
                                <p class="text-sm text-gray-600" id="convPhone"></p>
                            </div>
                            <button onclick="initiateCall()"
                                class="modern-button px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 mr-2"
                                title="Call this customer">
                                üìû Call
                            </button>
                            <button onclick="closeConversation()"
                                class="modern-button px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">
                                ‚úï Close
                            </button>
                        </div>
                        <div id="messageThread" class="bg-gray-50 rounded-xl p-4 mb-4 space-y-3 flex-1 overflow-y-auto"
                            style="min-height: 0;"></div>
                        <div class="flex-shrink-0">
                            <!-- Emoji Picker -->
                            <div id="emojiPicker"
                                class="hidden mb-2 p-3 bg-white rounded-xl border-2 border-gray-200 max-h-48 overflow-y-auto">
                                <div class="grid grid-cols-10 gap-1">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <!-- Message Input -->
                            <div class="flex gap-2">
                                <button onclick="toggleEmojiPicker()"
                                    class="modern-button px-3 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200"
                                    title="Emojis">
                                    üòä
                                </button>
                                <button onclick="document.getElementById('imageInput').click()"
                                    class="modern-button px-3 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200"
                                    title="Attach Image">
                                    üì∑
                                </button>
                                <input type="file" id="imageInput" accept="image/*" class="hidden"
                                    onchange="handleImageSelect()">
                                <input type="text" id="replyInput" placeholder="Type your message..."
                                    class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl"
                                    onkeypress="if(event.key==='Enter') sendReply()">
                                <button onclick="sendReply()"
                                    class="modern-button px-6 py-3 bg-primary text-white rounded-xl font-semibold hover-primary">
                                    Send
                                </button>
                            </div>
                            <!-- Signature Option -->
                            <div class="mt-2 flex items-center">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="addSignature" class="w-4 h-4 rounded border-gray-300">
                                    <span class="text-sm text-gray-600">Add signature: <span id="signaturePreview"
                                            class="font-medium text-gray-800"></span></span>
                                </label>
                            </div>
                            <!-- Image Preview -->
                            <div id="imagePreview" class="hidden mt-2 p-3 bg-white rounded-xl border-2 border-gray-200">
                                <div class="flex items-center gap-3">
                                    <img id="previewImg" src="" class="w-20 h-20 object-cover rounded-lg">
                                    <div class="flex-1">
                                        <p class="text-sm font-semibold" id="previewName"></p>
                                        <p class="text-xs text-gray-500" id="previewSize"></p>
                                    </div>
                                    <button onclick="clearImagePreview()"
                                        class="text-red-600 hover:text-red-800 font-semibold">
                                        ‚úï
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState"
                        class="glass-card rounded-2xl p-12 flex-1 flex flex-col items-center justify-center text-center">
                        <div class="text-6xl mb-4">üí¨</div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Select a Driver</h3>
                        <p class="text-gray-600">Click on any driver to start a conversation</p>
                    </div>

                    <!-- Results Section -->
                    <div id="resultsSection"
                        class="glass-card rounded-2xl p-6 flex-1 flex flex-col hidden overflow-hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">
                            üìä Results:
                            <span class="text-green-600"><span id="successCount">0</span> sent</span>,
                            <span class="text-red-600"><span id="failCount">0</span> failed</span>
                        </h2>
                        <div id="resultsList" class="space-y-2 overflow-y-auto flex-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-card rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">‚öôÔ∏è Settings</h2>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-gray-700 text-3xl">√ó</button>
            </div>
            <div class="space-y-4">
                <!-- Admin Only Settings -->
                <div class="bg-gray-50 p-4 rounded-xl border-2 border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700">üîê Admin Settings</h3>
                        <button id="unlockSettingsBtn" onclick="requestAdminUnlock()"
                            class="text-sm px-3 py-1 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                            üîí Unlock
                        </button>
                    </div>
                    <div id="adminSettingsGroup" class="space-y-4 opacity-50 pointer-events-none">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Account SID</label>
                            <input type="text" id="accountSid" class="w-full px-4 py-3 border-2 rounded-xl" disabled>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Auth Token</label>
                            <input type="password" id="authToken" class="w-full px-4 py-3 border-2 rounded-xl" disabled>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Twilio Phone Number</label>
                            <input type="text" id="twilioNumber" placeholder="+1234567890"
                                class="w-full px-4 py-3 border-2 rounded-xl" disabled>
                        </div>
                        <div class="col-span-2">
                            <button type="button" onclick="testConnection()" id="testConnectionBtn"
                                class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition text-sm">
                                üîå Test Connection
                            </button>
                            <p id="testConnectionResult" class="text-xs text-center mt-2 hidden"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Company Name</label>
                            <input type="text" id="companyNameSettings" placeholder="e.g. Acme Corp"
                                class="w-full px-4 py-3 border-2 rounded-xl" disabled>
                            <p class="text-xs text-gray-500 mt-1">Replaces "Driver" in the app header</p>
                        </div>
                    </div>
                </div>

                <!-- Notification Sound Picker -->
                <div class="pt-4 border-t-2 border-gray-200">
                    <label class="block text-sm font-semibold mb-2">üîî Notification Sound</label>
                    <div class="flex gap-2 mb-2">
                        <select id="notificationSound" onchange="saveNotificationSound()"
                            class="flex-1 px-4 py-3 border-2 rounded-xl">
                            <option value="playTrill">Trill (Rising tone)</option>
                            <option value="playBubble">Bubble (iMessage style)</option>
                            <option value="playBeep">Beep (Simple)</option>
                            <option value="playDoubleBeep">Double Beep</option>
                            <option value="playChime">Chime (High pitch)</option>
                            <option value="playDing">Ding (Bell)</option>
                            <option value="playWhoosh">Whoosh</option>
                            <option value="playPop">Pop (Quick)</option>
                            <option value="playPluck">Pluck (Guitar)</option>
                            <option value="playAlertTone">Alert (3 beeps)</option>
                            <option value="playSoftPing">Soft Ping</option>
                            <option value="playQuiet">Quiet (Subtle)</option>
                            <option value="none">None (Silent)</option>
                        </select>
                        <button onclick="previewNotificationSound()"
                            class="modern-button px-6 py-3 bg-primary-lighter text-primary-dark rounded-xl font-semibold"
                            style="background-color: var(--primary-lighter); color: var(--primary-dark);">
                            üîä Preview
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Click anywhere on the page first to enable audio in your
                        browser</p>
                </div>

                <!-- Color Theme Picker -->
                <div class="pt-4 border-t-2 border-gray-200">
                    <label class="block text-sm font-semibold mb-2">üé® Color Theme</label>
                    <select id="colorTheme" onchange="saveTheme()" class="w-full px-4 py-3 border-2 rounded-xl">
                        <option value="purple">Purple (Default)</option>
                        <option value="blue">Blue Ocean</option>
                        <option value="green">Green Mint</option>
                        <option value="orange">Orange Sunset</option>
                        <option value="pink">Pink Rose</option>
                        <option value="dark">Dark Mode</option>
                    </select>
                </div>

                <!-- Blacklist Management -->
                <div class="pt-4 border-t-2 border-gray-200">
                    <label class="block text-sm font-semibold mb-2">üö´ Blacklist (STOP Responses)</label>
                    <div id="blacklistContainer" class="mb-2 max-h-32 overflow-y-auto bg-gray-50 rounded-xl p-3">
                        <!-- Populated by JavaScript -->
                    </div>
                    <p class="text-xs text-gray-500">Drivers who replied "STOP" will be automatically blocked from
                        bulk messages</p>
                </div>

                <!-- Clear Driver List -->
                <div class="pt-4 border-t-2 border-gray-200">
                    <label class="block text-sm font-semibold mb-2">üìã Update Driver List</label>
                    <label
                        class="w-full px-4 py-2 bg-primary-lighter text-primary-dark rounded-xl font-medium cursor-pointer inline-block text-center"
                        style="background-color: var(--primary-lighter); color: var(--primary-dark);">
                        üìÅ Choose Excel File
                        <input type="file" id="fileInput2" accept=".xlsx,.xls" class="hidden"
                            onchange="handleFileUpload2()">
                    </label>
                    <p class="text-xs text-gray-500 mt-2">Upload a new driver list to replace the current one</p>
                </div>

                <div class="pt-4 border-t-2 border-gray-200">
                    <button onclick="clearDriverCache()"
                        class="w-full px-4 py-2 bg-red-100 text-red-700 rounded-xl font-medium hover:bg-red-200">
                        üóëÔ∏è Clear Saved Driver List
                    </button>
                    <p class="text-xs text-gray-500 mt-2">Clear cached driver data if you need to start fresh</p>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 mb-4">‚òÅÔ∏è Cloud Sync</h3>
                <p class="text-sm text-gray-600 mb-4">
                    Upload your local message history (colors/names) to the cloud so it appears on the web version.
                </p>
                <button onclick="syncHistory()"
                    class="modern-button px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 w-full">
                    üîÑ Sync History to Cloud
                </button>
            </div>
        </div>
        <button onclick="saveSettings()"
            class="w-full mt-6 px-6 py-3 bg-primary text-white rounded-xl font-semibold hover-primary">
            Save Settings
        </button>
    </div>
    </div>

    <!-- Bulk Message Modal -->
    <div id="bulkModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-card rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">üì§ Send Bulk Message</h2>
                <button onclick="closeBulkModal()" class="text-gray-500 hover:text-gray-700 text-3xl">√ó</button>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Select Team</label>
                <select id="bulkTeamSelect" onchange="updateBulkList()"
                    class="w-full px-4 py-3 border-2 rounded-xl font-semibold"></select>
            </div>

            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-semibold">Select Drivers</label>
                    <div class="flex gap-2">
                        <button onclick="selectAllBulk()" class="text-sm font-medium text-primary">Select
                            All</button>
                        <button onclick="deselectAllBulk()" class="text-sm text-gray-600 font-medium">Deselect
                            All</button>
                    </div>
                </div>
                <p id="bulkCount" class="text-sm text-gray-600 mb-3"></p>
                <div id="bulkDriverList" class="border-2 rounded-xl max-h-64 overflow-y-auto p-4 bg-gray-50"></div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Message</label>
                <textarea id="bulkMessage" rows="5" class="w-full px-4 py-3 border-2 rounded-xl"
                    oninput="updateBulkPreview()"></textarea>
                <p class="text-sm text-gray-500 mt-2">Use: {firstName}, {name}, {team}</p>
            </div>

            <div class="mb-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="bulkAddSignature" onchange="updateBulkPreview()"
                        class="w-4 h-4 rounded border-gray-300">
                    <span class="text-sm font-semibold">Add my signature: <span id="bulkSignaturePreview"
                            class="font-medium text-gray-800"></span></span>
                </label>
            </div>

            <div id="bulkPreviewBox" class="mb-4 p-5 rounded-2xl border-4 shadow-lg hidden"
                style="background: linear-gradient(to right, var(--primary-lighter), var(--primary-lighter)); border-color: var(--primary-light);">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">üì±</span>
                    <p class="text-base font-bold" style="color: var(--primary-dark);">Live Preview</p>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <p id="bulkPreviewText" class="text-gray-900 whitespace-pre-wrap text-sm leading-relaxed"></p>
                </div>
                <p class="text-xs mt-2 font-medium" style="color: var(--primary-dark);">This is how the message will
                    appear to the first selected driver</p>
            </div>

            <button onclick="sendBulk()"
                class="w-full px-6 py-4 bg-primary text-white rounded-xl font-bold text-lg hover-primary">
                üöÄ Send Messages
            </button>
        </div>
    </div>

    <!-- New Message Modal -->
    <div id="newMessageModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-card rounded-2xl p-6 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">‚ûï New Message</h2>
                <button onclick="closeNewMessageModal()" class="text-gray-500 hover:text-gray-700 text-3xl">√ó</button>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Phone Number</label>
                <input type="tel" id="newPhone" placeholder="+1234567890" class="w-full px-4 py-3 border-2 rounded-xl"
                    onkeypress="if(event.key==='Enter') document.getElementById('newName').focus()">
                <p class="text-xs text-gray-500 mt-1">Include country code (e.g., +1 for US)</p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Name (optional)</label>
                <input type="text" id="newName" placeholder="John Doe" class="w-full px-4 py-3 border-2 rounded-xl"
                    onkeypress="if(event.key==='Enter') startNewConversation()">
                <p class="text-xs text-gray-500 mt-1">Give this contact a name for easy reference</p>
            </div>

            <button onclick="startNewConversation()"
                class="w-full px-6 py-4 bg-green-600 text-white rounded-xl font-bold text-lg hover:bg-green-700">
                üí¨ Start Conversation
            </button>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="userManagementModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-card rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="formTitle">Add New User</h2>
                <button onclick="closeUserManagement()" class="text-gray-500 hover:text-gray-700 text-3xl">√ó</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-3">User List</h3>
                    <div id="userList" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Users will be loaded here -->
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-3">User Details</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Username (Email)</label>
                            <input type="email" id="newUserName" placeholder="user@example.com"
                                class="w-full px-4 py-3 border-2 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Password</label>
                            <input type="password" id="newUserPass" placeholder="e.g., secret123"
                                class="w-full px-4 py-3 border-2 rounded-xl">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2">Role (Title)</label>
                            <select id="newUserRole" class="w-full px-4 py-3 border-2 rounded-xl">
                                <option value="User">User</option>
                                <option value="Dispatcher">Dispatcher</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Manager">Manager</option>
                                <option value="Director">Director</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2">Company</label>
                            <input type="text" id="newUserCompany" placeholder="Acme Corp"
                                class="w-full px-4 py-3 border-2 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Color</label>
                            <div id="colorPalette" class="flex flex-wrap gap-2">
                                <button class="w-8 h-8 rounded-full bg-indigo-600 ring-2 ring-offset-2 ring-indigo-500"
                                    data-color="#4f46e5" onclick="selectColor(this, '#4f46e5')"></button>
                                <button class="w-8 h-8 rounded-full bg-blue-600" data-color="#2563eb"
                                    onclick="selectColor(this, '#2563eb')"></button>
                                <button class="w-8 h-8 rounded-full bg-green-600" data-color="#16a34a"
                                    onclick="selectColor(this, '#16a34a')"></button>
                                <button class="w-8 h-8 rounded-full bg-red-600" data-color="#dc2626"
                                    onclick="selectColor(this, '#dc2626')"></button>
                                <button class="w-8 h-8 rounded-full bg-yellow-600" data-color="#ca8a04"
                                    onclick="selectColor(this, '#ca8a04')"></button>
                                <button class="w-8 h-8 rounded-full bg-purple-600" data-color="#9333ea"
                                    onclick="selectColor(this, '#9333ea')"></button>
                                <button class="w-8 h-8 rounded-full bg-pink-600" data-color="#db2777"
                                    onclick="selectColor(this, '#db2777')"></button>
                                <button class="w-8 h-8 rounded-full bg-gray-600" data-color="#4b5563"
                                    onclick="selectColor(this, '#4b5563')"></button>
                            </div>
                            <input type="hidden" id="newUserColor" value="#4f46e5">
                        </div>
                        <button onclick="addUser()" id="addUserBtn"
                            class="w-full px-6 py-3 bg-primary text-white rounded-xl font-semibold hover-primary">
                            ‚ûï Add User
                        </button>
                        <button onclick="resetUserForm()" id="cancelEditBtn"
                            class="hidden w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 mt-2">
                            Cancel Edit
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Verification Modal -->
    <div id="securityModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-card rounded-2xl p-6 max-w-sm w-full">
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">üîí</div>
                <h2 class="text-xl font-bold text-gray-800">Security Check</h2>
                <p class="text-sm text-gray-600">Please verify your identity to access settings.</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Enter Password</label>
                    <input type="password" id="secPass1" class="w-full px-4 py-3 border-2 rounded-xl"
                        placeholder="Your password">
                </div>
                <div id="secPass2Container" class="hidden">
                    <label class="block text-sm font-semibold mb-2">Re-enter Password</label>
                    <input type="password" id="secPass2" class="w-full px-4 py-3 border-2 rounded-xl"
                        placeholder="Confirm password">
                </div>
                <button onclick="verifySecurity()" id="secVerifyBtn"
                    class="w-full px-6 py-3 bg-primary text-white rounded-xl font-bold hover-primary">
                    Verify
                </button>
                <button onclick="closeSecurityModal()"
                    class="w-full px-6 py-3 text-gray-500 font-semibold hover:text-gray-700">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    </div><!-- Close mainApp -->
    </div><!-- Close max-w-6xl -->

    <script>
        let drivers = [];
        let teams = [];
        let conversations = {};
        let currentDriver = null;
        let sortBy = 'recent'; // 'recent', 'team', 'myRecent'
        let sortReverse = false;
        let users = [];
        let currentUser = null;
        let currentUserRole = 'User';
        let currentUserColor = '#667eea';
        let globalCompanyName = ''; // Store global company name
        let selectedDriverIds = new Set();
        let unreadDrivers = new Set();
        let lastMessageCount = {};
        let mediaCache = {}; // Cache for authenticated media URLs
        let notificationSoundPreference = 'playTrill';
        let blacklistedNumbers = new Set();
        let currentTheme = 'purple';
        let audioContextReady = false;
        let selectedImage = null;
        let searchQuery = '';

        // Backend API URL - automatically detects environment
        // Backend API URL
        // Improved logic: Default to production even on localhost, unless env=local is specified
        const urlParams = new URLSearchParams(window.location.search);
        const useLocalBackend = urlParams.get('env') === 'local';

        const BACKEND_URL = (useLocalBackend && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:'))
            ? 'http://127.0.0.1:8787'  // Local development (only if requested)
            : 'https://sms-backend.jamie-381.workers.dev'; // Production default

        // Get tenant from subdomain for multi-tenancy
        const getTenant = () => {
            const hostname = window.location.hostname;
            const parts = hostname.split('.');

            // Handle test.toc.smsmgr.com -> returns 'toc'
            if (parts[0] === 'test' && parts.length > 3) {
                return parts[1];
            }

            // If subdomain exists (e.g., toc.smsmgr.com), return 'toc'
            if (parts.length > 2 && parts[0] !== 'www') {
                return parts[0];
            }
            return 'default';
        };

        const TENANT = getTenant();
        console.log('Environment:', window.location.hostname);
        console.log('Backend URL:', BACKEND_URL);
        console.log('Tenant:', TENANT);

        // Wrapper for fetch to include Tenant ID
        const apiFetch = async (endpoint, options = {}) => {
            const headers = options.headers || {};
            if (!(headers instanceof Headers)) {
                // Ensure headers is an object
                options.headers = {
                    ...headers,
                    'X-Tenant-ID': TENANT
                };
            } else {
                headers.set('X-Tenant-ID', TENANT);
            }
            return fetch(endpoint, options);
        };


        function handleSearch() {
            const query = document.getElementById('driverSearch').value.toLowerCase().trim();
            searchQuery = query;

            // Toggle clear button
            const clearBtn = document.getElementById('clearSearchBtn');
            if (query.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }

            updateDriverList();
        }

        function clearSearch() {
            document.getElementById('driverSearch').value = '';
            handleSearch();
            document.getElementById('driverSearch').focus();
        }
        // Emoji list
        const emojis = [
            'üòä', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üëé', 'üôè', 'üíØ', 'üî•', '‚úÖ', '‚ùå',
            'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòá', 'üòâ', 'üòå',
            'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'ü§ó', 'ü§©', 'ü§î', 'ü§®',
            'üòê', 'üòë', 'üò∂', 'üôÑ', 'üòè', 'üò£', 'üò•', 'üòÆ', 'ü§ê', 'üòØ',
            'üò™', 'üò´', 'üò¥', 'üòå', 'üòõ', 'üòú', 'üòù', 'ü§§', 'üòí', 'üòì',
            'üòî', 'üòï', 'üôÉ', 'ü§ë', 'üò≤', 'üòû', 'üòü', 'üò§', 'üò¢', 'üò≠',
            'üò¶', 'üòß', 'üò®', 'üò©', 'ü§Ø', 'üò¨', 'üò∞', 'üò±', 'ü•µ', 'ü•∂',
            'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û',
            'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç',
            'üéâ', 'üéä', 'üéà', 'üéÅ', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', '‚öΩ', 'üèÄ',
            'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê',
            'üì±', 'üíª', '‚åö', 'üìû', 'üìß', 'üì®', 'üì©', 'üì¨', 'üì≠', 'üìÆ',
            '‚è∞', '‚åõ', '‚è≥', '‚åö', 'üìÖ', 'üìÜ', 'üóìÔ∏è', 'üìã', 'üìå', 'üìç',
            'üí∞', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'üí∏', 'üí≥', 'üßæ', 'üíπ', 'üìà',
            '‚òÄÔ∏è', 'üå§Ô∏è', '‚õÖ', 'üå•Ô∏è', '‚òÅÔ∏è', 'üå¶Ô∏è', 'üåßÔ∏è', '‚õàÔ∏è', 'üå©Ô∏è', 'üå®Ô∏è',
            '‚≠ê', 'üåü', '‚ú®', '‚ö°', 'üî•', 'üí•', '‚òÑÔ∏è', 'üåà', 'üåä', 'üíß'
        ];

        // Enable audio on first user interaction
        function enableAudio() {
            if (!audioContextReady) {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    const ctx = new AudioContext();
                    ctx.resume();
                    audioContextReady = true;
                    console.log('Audio context enabled');
                } catch (e) {
                    console.log('Could not enable audio context:', e);
                }
            }
        }

        // Add click listener to enable audio
        document.addEventListener('click', enableAudio, { once: true });

        // Close emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            const picker = document.getElementById('emojiPicker');
            const emojiBtn = e.target.closest('button[onclick*="toggleEmojiPicker"]');
            const insidePicker = e.target.closest('#emojiPicker');

            if (!emojiBtn && !insidePicker && picker && !picker.classList.contains('hidden')) {
                picker.classList.add('hidden');
            }
        });

        window.onload = async () => {
            loadCredentials();
            loadBlacklist();
            loadTheme();
            loadCachedDrivers();
            loadAdHocContacts(); // Load ad-hoc contacts before cached conversations
            loadCachedConversations();
            initializeEmojiPicker();

            // Check Cloudflare Auth
            await checkAuth();

            setInterval(pollMessages, 15000);
            registerServiceWorker();
            requestNotificationPermission();
        };

        async function checkAuth() {
            const auth = sessionStorage.getItem('auth');
            if (!auth) {
                document.getElementById('loginScreen').classList.remove('hidden');
                return;
            }

            try {
                // 1. Verify Token & Get Username
                const res = await apiFetch(`${BACKEND_URL}/api/me`, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.email) {
                        currentUser = data.email;
                        document.getElementById('currentUserDisplay').textContent = currentUser;
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');

                        // Show manage users button if admin
                        if (currentUser === 'admin') {
                            document.getElementById('manageUsersBtn').classList.remove('hidden');
                        }

                        // 2. Fetch User Details (Color, Role, Company)
                        try {
                            const userRes = await apiFetch(`${BACKEND_URL}/api/users`, {
                                headers: { 'Authorization': `Basic ${auth}` }
                            });
                            if (userRes.ok) {
                                const userData = await userRes.json();
                                users = userData.users; // Update global users list
                                const myUser = users.find(u => u.username === currentUser);
                                if (myUser) {
                                    if (myUser.color) {
                                        currentUserColor = myUser.color;
                                        applyUserTheme(myUser.color);
                                    }
                                    if (myUser.role) {
                                        currentUserRole = myUser.role;
                                    }
                                }
                            }
                        } catch (err) {
                            console.error('Failed to fetch user details:', err);
                        }

                        // 3. Load company name from settings
                        try {
                            const settingsRes = await apiFetch(`${BACKEND_URL}/api/settings`, {
                                headers: { 'Authorization': `Basic ${auth}` }
                            });
                            if (settingsRes.ok) {
                                const settingsData = await settingsRes.json();
                                if (settingsData.company) {
                                    globalCompanyName = settingsData.company; // Store globally
                                    updateHeaderTitle(settingsData.company);
                                }
                            }
                        } catch (err) {
                            console.error('Failed to fetch settings:', err);
                        }

                        return;
                    }
                }
            } catch (e) {
                console.log('Auth check failed:', e);
            }
            // If we get here, auth failed
            sessionStorage.removeItem('auth');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function applyUserTheme(color) {
            const input = document.getElementById('replyInput');
            if (input) {
                input.style.borderColor = color;
                input.style.borderWidth = '2px';
                // Add a very subtle background tint
                // distinct from the white background
                input.style.boxShadow = `0 0 0 3px ${color}20`; // 20 is hex for ~12% opacity
            }

            // Also update the "Logged in as" color
            const userDisplay = document.getElementById('currentUserDisplay');
            if (userDisplay) {
                userDisplay.style.color = color;
            }
        }

        async function login() {
            const user = document.getElementById('usernameInput').value.trim();
            const pass = document.getElementById('passwordInput').value.trim();

            if (!user || !pass) {
                alert('Please enter username and password');
                return;
            }

            const auth = btoa(`${user}:${pass}`);

            try {
                const res = await apiFetch(`${BACKEND_URL}/api/me`, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });

                if (res.ok) {
                    sessionStorage.setItem('auth', auth);
                    window.location.reload();
                } else {
                    alert('Invalid credentials');
                }
            } catch (e) {
                alert('Login error: ' + e.message);
            }
        }

        function logout() {
            if (confirm('Log out?')) {
                sessionStorage.removeItem('auth');
                currentUser = null;
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('usernameInput').value = '';
                document.getElementById('passwordInput').value = '';
            }
        }



        function initializeEmojiPicker() {
            const picker = document.querySelector('#emojiPicker .grid');
            if (!picker) return;

            picker.innerHTML = emojis.map(emoji =>
                `<button onclick="insertEmoji('${emoji}')" class="text-2xl hover:bg-gray-100 rounded p-1 cursor-pointer">${emoji}</button>`
            ).join('');
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('hidden');
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('replyInput');
            input.value += emoji;
            input.focus();
        }

        function handleImageSelect() {
            const input = document.getElementById('imageInput');
            const file = input.files[0];

            if (!file) return;

            // Check file size (max 5MB for MMS)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image too large! Maximum size is 5MB.');
                input.value = '';
                return;
            }

            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                input.value = '';
                return;
            }

            selectedImage = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('previewName').textContent = file.name;
                document.getElementById('previewSize').textContent = formatFileSize(file.size);
                document.getElementById('imagePreview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearImagePreview() {
            selectedImage = null;
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('Service Worker registered');
                }).catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
            }
        }

        function loadCredentials() {
            document.getElementById('accountSid').value = localStorage.getItem('accountSid') || '';
            document.getElementById('authToken').value = localStorage.getItem('authToken') || '';
            document.getElementById('twilioNumber').value = localStorage.getItem('twilioNumber') || '';

            const savedSound = localStorage.getItem('notificationSound') || 'playTrill';
            notificationSoundPreference = savedSound;
            document.getElementById('notificationSound').value = savedSound;
        }

        function loadBlacklist() {
            const saved = localStorage.getItem('blacklistedNumbers');
            if (saved) {
                blacklistedNumbers = new Set(JSON.parse(saved));
                console.log(`Loaded ${blacklistedNumbers.size} blacklisted numbers`);
            }
        }

        function saveBlacklist() {
            localStorage.setItem('blacklistedNumbers', JSON.stringify([...blacklistedNumbers]));
        }

        function loadTheme() {
            currentTheme = localStorage.getItem('colorTheme') || 'purple';
            document.documentElement.setAttribute('data-theme', currentTheme);
            if (document.getElementById('colorTheme')) {
                document.getElementById('colorTheme').value = currentTheme;
            }
        }

        function saveTheme() {
            const theme = document.getElementById('colorTheme').value;
            currentTheme = theme;
            localStorage.setItem('colorTheme', theme);
            document.documentElement.setAttribute('data-theme', theme);
        }

        function loadCachedConversations() {
            try {
                const cached = localStorage.getItem('cachedConversations');
                if (cached) {
                    conversations = JSON.parse(cached);
                    console.log(`Loaded cached conversations for ${Object.keys(conversations).length} numbers`);
                    updateDriverList();
                }
            } catch (e) {
                console.error('Error loading cached conversations:', e);
            }
        }

        function saveCachedConversations() {
            try {
                localStorage.setItem('cachedConversations', JSON.stringify(conversations));
            } catch (e) {
                console.error('Error saving conversations:', e);
            }
        }

        function saveNotificationSound() {
            const sound = document.getElementById('notificationSound').value;
            notificationSoundPreference = sound;
            localStorage.setItem('notificationSound', sound);
        }

        function saveAdHocContacts() {
            try {
                const adHocContacts = drivers.filter(d => d.isAdHoc);
                localStorage.setItem('adHocContacts', JSON.stringify(adHocContacts));
                console.log('Saved', adHocContacts.length, 'ad-hoc contacts');
            } catch (e) {
                console.error('Error saving ad-hoc contacts:', e);
            }
        }

        function loadAdHocContacts() {
            try {
                const saved = localStorage.getItem('adHocContacts');
                if (saved) {
                    const adHocContacts = JSON.parse(saved);
                    console.log('Loading', adHocContacts.length, 'ad-hoc contacts');

                    // Add them to drivers if they don't exist
                    adHocContacts.forEach(contact => {
                        if (!drivers.find(d => d.phone === contact.phone)) {
                            drivers.push(contact);
                        }
                    });

                    // Add the ad-hoc team if it doesn't exist
                    if (adHocContacts.length > 0 && !teams.includes('üì± Ad-Hoc Contacts')) {
                        teams.push('üì± Ad-Hoc Contacts');
                    }
                }
            } catch (e) {
                console.error('Error loading ad-hoc contacts:', e);
            }
        }

        function previewNotificationSound() {
            enableAudio(); // Make sure audio is enabled
            const sound = document.getElementById('notificationSound').value;
            if (sound === 'none') {
                alert('Silent mode - no sound will play');
            } else {
                console.log('Previewing sound:', sound);
                try {
                    window[sound]();
                } catch (e) {
                    console.error('Error previewing sound:', e);
                    alert('Error playing sound. Check browser console.');
                }
            }
        }

        function testNotification() {
            enableAudio(); // Make sure audio is enabled
            console.log('Testing notification...');
            console.log('Current sound preference:', notificationSoundPreference);

            // Play sound
            playNotificationSound();

            // Show browser notification if permitted
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("Test Message", {
                    body: "This is a test notification with sound",
                    icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23667eea'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>üí¨</text></svg>"
                });
            } else {
                alert('‚úÖ Sound should have played!\n\n(Browser notifications not enabled, but sound should work)');
            }
        }


        // currentUserRole is defined globally
        let securityStep = 0;

        async function showSettings() {
            // Open Settings for everyone
            document.getElementById('settingsModal').classList.remove('hidden');
            updateBlacklistDisplay();

            // Load settings from backend
            await loadSettings();

            // Always lock admin fields initially
            lockAdminFields();
        }

        async function loadSettings() {
            try {
                const auth = sessionStorage.getItem('auth');
                if (!auth) return;

                const res = await fetch(`${BACKEND_URL}/api/settings`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Basic ${auth}`
                    }
                });

                if (res.ok) {
                    const data = await res.json();

                    // Populate fields (masked for non-admins)
                    if (data.sid) document.getElementById('accountSid').value = data.sid;
                    if (data.token) document.getElementById('authToken').value = data.token;
                    if (data.number) document.getElementById('twilioNumber').value = data.number;
                    if (data.company) {
                        document.getElementById('companyNameSettings').value = data.company;
                        globalCompanyName = data.company; // Store globally
                        updateHeaderTitle(data.company);
                    }
                }
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        async function syncHistory() {
            if (!confirm('This will upload your local message colors and names to the cloud. Continue?')) return;

            const auth = sessionStorage.getItem('auth');
            if (!auth) return;

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = '‚è≥ Syncing...';
            btn.disabled = true;

            try {
                // Collect all metadata from local conversations
                const batchData = {};
                let count = 0;

                Object.values(conversations).forEach(msgs => {
                    msgs.forEach(m => {
                        // Only sync outbound messages that have sender info
                        if (m.direction === 'outbound-api' && m.senderName && m.senderColor) {
                            batchData[m.sid] = {
                                user: m.senderName,
                                color: m.senderColor
                            };
                            count++;
                        }
                    });
                });

                if (count === 0) {
                    alert('No local history found to sync.');
                    return;
                }

                console.log(`Syncing ${count} messages...`);

                const res = await apiFetch(`${BACKEND_URL}/api/meta/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Basic ${auth}`
                    },
                    body: JSON.stringify(batchData)
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(`‚úÖ Successfully synced ${data.count} messages to the cloud!`);
                } else {
                    const err = await res.text();
                    alert('Sync failed: ' + err);
                }

            } catch (e) {
                console.error('Sync error:', e);
                alert('Sync error: ' + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function lockAdminFields() {
            const group = document.getElementById('adminSettingsGroup');
            const btn = document.getElementById('unlockSettingsBtn');

            if (!group || !btn) {
                console.warn('Admin settings elements not found');
                return;
            }

            const inputs = group.querySelectorAll('input');

            group.classList.add('opacity-50', 'pointer-events-none');
            inputs.forEach(input => input.disabled = true);

            btn.innerHTML = 'üîí Unlock';
            btn.classList.remove('bg-green-100', 'text-green-700');
            btn.classList.add('bg-gray-200', 'text-gray-700');
            btn.onclick = requestAdminUnlock;
        }

        function unlockAdminSettings() {
            const group = document.getElementById('adminSettingsGroup');
            const btn = document.getElementById('unlockSettingsBtn');

            if (!group || !btn) {
                console.warn('Admin settings elements not found');
                return;
            }

            const inputs = group.querySelectorAll('input');

            group.classList.remove('opacity-50', 'pointer-events-none');
            inputs.forEach(input => input.disabled = false);

            btn.innerHTML = 'üîì Unlocked';
            btn.classList.remove('bg-gray-200', 'text-gray-700');
            btn.classList.add('bg-green-100', 'text-green-700');
            btn.onclick = null; // Disable button
        }

        function requestAdminUnlock() {
            // Allow if username is 'admin' OR role is 'Admin'
            if (currentUser !== 'admin' && currentUserRole !== 'Admin') {
                alert('üö´ Access Denied: Only Admins can edit these settings.');
                return;
            }

            // Open Security Modal
            document.getElementById('securityModal').classList.remove('hidden');
            document.getElementById('secPass1').value = '';
            document.getElementById('secPass2').value = '';
            document.getElementById('secPass2Container').classList.add('hidden');
            document.getElementById('secVerifyBtn').textContent = 'Verify';
            securityStep = 1;
            document.getElementById('secPass1').focus();
        }

        function closeSecurityModal() {
            document.getElementById('securityModal').classList.add('hidden');
        }

        async function verifySecurity() {
            const p1 = document.getElementById('secPass1').value;

            if (!p1) {
                alert('Please enter password');
                return;
            }

            // Verify against current session
            const auth = sessionStorage.getItem('auth');
            if (!auth) return;

            try {
                // auth is stored as raw base64 in sessionStorage (see login function)
                const decoded = atob(auth);
                const [user, pass] = decoded.split(':');

                if (p1 !== pass) {
                    alert('‚ùå Incorrect password');
                    return;
                }

                if (securityStep === 1) {
                    // Step 1 passed, ask for confirmation (Double Entry)
                    securityStep = 2;
                    document.getElementById('secPass1').value = ''; // Clear first entry
                    document.getElementById('secPass1').placeholder = 'Enter password again';
                    document.getElementById('secPass2Container').classList.add('hidden');
                    alert('‚úÖ Verified. Please enter password again to confirm.');
                    document.getElementById('secPass1').focus();
                    document.getElementById('secVerifyBtn').textContent = 'Confirm & Unlock';
                } else {
                    // Step 2 passed
                    closeSecurityModal();
                    unlockAdminSettings();
                    alert('‚úÖ Admin settings unlocked!');
                }

            } catch (e) {
                console.error(e);
                alert('Error verifying password: ' + e.message);
            }
        }

        function updateBlacklistDisplay() {
            const container = document.getElementById('blacklistContainer');
            if (!container) return;

            if (!blacklistedNumbers || blacklistedNumbers.size === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 italic">No blacklisted numbers</p>';
            } else {
                const safeDrivers = Array.isArray(drivers) ? drivers : [];
                container.innerHTML = [...blacklistedNumbers].map(phone => {
                    const driver = safeDrivers.find(d => d.phone === phone);
                    const name = driver ? driver.name : phone;
                    return `
                        <div class="flex justify-between items-center p-2 bg-white rounded-lg mb-1">
                            <span class="text-sm">${name} (${phone})</span>
                            <button onclick="removeFromBlacklist('${phone}')" class="text-xs text-red-600 hover:text-red-800 font-medium">
                                Remove
                            </button>
                        </div>
                    `;
                }).join('');
            }
        }

        function removeFromBlacklist(phone) {
            if (confirm('Remove this number from blacklist? They will be able to receive messages again.')) {
                blacklistedNumbers.delete(phone);
                saveBlacklist();
                updateBlacklistDisplay();
                updateDriverList();
            }
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function handleFileUpload() {
            processFile(document.getElementById('fileInput').files[0]);
        }

        function handleFileUpload2() {
            // Clear existing cache before processing new file
            try {
                localStorage.removeItem('cachedDrivers');
                localStorage.removeItem('cachedTeams');
                localStorage.removeItem('driversLastUpdated');
                drivers = [];
                teams = [];
                console.log('Cleared driver cache for new upload');
            } catch (e) {
                console.error('Error clearing cache:', e);
            }

            processFile(document.getElementById('fileInput2').files[0]);
            closeSettings();
        }

        function processFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);

                    drivers = json
                        .filter(row => {
                            // Must have a phone number
                            if (!row['Phone']) return false;

                            // Must be active (explicitly "Yes", not "No" or empty)
                            const activeStatus = row['Active'] ? row['Active'].toString().trim().toLowerCase() : '';
                            return activeStatus === 'yes';
                        })
                        .map((row, i) => ({
                            id: i,
                            name: row['Full Name'] || '',
                            firstName: (row['Full Name'] || '').split(' ')[0],
                            phone: row['Phone'] || '',
                            team: row['Active Team'] || ''
                        }));

                    teams = ['all', ...new Set(drivers.map(d => d.team).filter(Boolean))].sort((a, b) => {
                        if (a === 'all') return -1;
                        if (b === 'all') return 1;
                        return a.localeCompare(b);
                    });

                    saveDriversToCache();

                    const teamSelect = document.getElementById('teamSelect');
                    teamSelect.innerHTML = teams.map(t => {
                        const count = t === 'all' ? drivers.length : drivers.filter(d => d.team === t).length;
                        return `<option value="${t}">${t === 'all' ? 'üåç All Teams' : t} (${count})</option>`;
                    }).join('');

                    // Default to "all" teams
                    teamSelect.value = 'all';

                    document.getElementById('uploadPrompt').classList.add('hidden');
                    document.getElementById('mainInterface').classList.remove('hidden');
                    updateDriverList();
                    alert(`‚úÖ Loaded ${drivers.length} drivers`);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function saveDriversToCache() {
            try {
                localStorage.setItem('cachedDrivers', JSON.stringify(drivers));
                localStorage.setItem('cachedTeams', JSON.stringify(teams));
                localStorage.setItem('driversLastUpdated', new Date().toISOString());
            } catch (e) {
                console.log('Could not cache drivers:', e);
            }
        }

        function updateTeamOptions() {
            const teamSelect = document.getElementById('teamSelect');
            if (teamSelect) {
                teamSelect.innerHTML = teams.map(t => {
                    const count = t === 'all' ? drivers.length : drivers.filter(d => d.team === t).length;
                    return `<option value="${t}">${t === 'all' ? 'üåç All Teams' : t} (${count})</option>`;
                }).join('');
            }
        }

        function loadCachedDrivers() {
            try {
                const cachedDrivers = localStorage.getItem('cachedDrivers');
                const cachedTeams = localStorage.getItem('cachedTeams');
                const lastUpdated = localStorage.getItem('driversLastUpdated');

                console.log('Checking for cached drivers...', cachedDrivers ? 'Found' : 'Not found');

                if (cachedDrivers && cachedTeams) {
                    drivers = JSON.parse(cachedDrivers);
                    teams = JSON.parse(cachedTeams);

                    console.log(`Loaded ${drivers.length} cached drivers`);

                    if (drivers.length > 0) {
                        const teamSelect = document.getElementById('teamSelect');
                        if (teamSelect) {
                            teamSelect.innerHTML = teams.map(t => {
                                const count = t === 'all' ? drivers.length : drivers.filter(d => d.team === t).length;
                                return `<option value="${t}">${t === 'all' ? 'üåç All Teams' : t} (${count})</option>`;
                            }).join('');

                            // Default to "all" teams
                            teamSelect.value = 'all';

                            document.getElementById('uploadPrompt').classList.add('hidden');
                            document.getElementById('mainInterface').classList.remove('hidden');
                            updateDriverList();

                            if (lastUpdated) {
                                const date = new Date(lastUpdated);
                                console.log(`Driver list loaded (last updated: ${date.toLocaleString()})`);
                            }
                        }
                    }
                } else {
                    console.log('No cached drivers found - showing upload screen');
                }
            } catch (e) {
                console.error('Error loading cached drivers:', e);
            }
        }

        function clearDriverCache() {
            if (confirm('Clear saved driver list? You will need to upload again.')) {
                localStorage.removeItem('cachedDrivers');
                localStorage.removeItem('cachedTeams');
                localStorage.removeItem('driversLastUpdated');
                drivers = [];
                teams = [];
                document.getElementById('uploadPrompt').classList.remove('hidden');
                document.getElementById('mainInterface').classList.add('hidden');
                alert('Driver list cleared');
            }
        }

        function sortDrivers(type) {
            if (sortBy === type) {
                // If clicking same sort, toggle reverse (except for 'recent' which usually stays desc)
                // Actually let's just keep it simple: clicking 'recent' always resets to standard recent
                if (type !== 'recent' && type !== 'myRecent') sortReverse = !sortReverse;
            } else {
                sortBy = type;
                sortReverse = false;
            }

            // Update buttons
            ['recent', 'name', 'team', 'myRecent'].forEach(t => {
                const btn = document.getElementById(`sort${t.charAt(0).toUpperCase() + t.slice(1)}Btn`);
                if (btn) {
                    if (t === sortBy) {
                        btn.classList.remove('bg-gray-200', 'text-gray-700');
                        btn.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                        btn.classList.remove('bg-indigo-600', 'text-white');
                    }
                }
            });

            updateDriverList();
        }

        function getLastMessageTime(phone) {
            const msgs = conversations[phone];
            if (!msgs || msgs.length === 0) return 0;
            // Use the last message regardless of sender
            const last = msgs[msgs.length - 1];
            return last.timestamp ? new Date(last.timestamp).getTime() : 0;
        }

        function getLastMyMessageTime(phone) {
            const msgs = conversations[phone];
            if (!msgs || msgs.length === 0) return 0;

            // Find last message sent by current user
            // We check senderName against currentUser
            // Note: senderName might be null for old messages, so this only works for new/synced ones
            for (let i = msgs.length - 1; i >= 0; i--) {
                const m = msgs[i];
                if (m.direction === 'outbound-api' && m.senderName === currentUser) {
                    return m.timestamp ? new Date(m.timestamp).getTime() : 0;
                }
            }
            return 0;
        }

        function getLastMessagePreview(phone) {
            const msgs = conversations[phone] || [];
            if (msgs.length === 0) return { text: 'No messages yet', time: '' };

            const lastMsg = msgs.reduce((latest, msg) => {
                const msgTime = msg.timestamp ? new Date(msg.timestamp).getTime() : 0;
                const latestTime = latest.timestamp ? new Date(latest.timestamp).getTime() : 0;
                return msgTime > latestTime ? msg : latest;
            }, msgs[0]);

            const preview = lastMsg.body.length > 40 ? lastMsg.body.substring(0, 40) + '...' : lastMsg.body;
            const timeStr = formatMessageTime(lastMsg.timestamp);
            const isOutbound = lastMsg.direction === 'outbound-api';

            return {
                text: (isOutbound ? 'You: ' : '') + preview,
                time: timeStr,
                isOutbound: isOutbound
            };
        }

        function formatMessageTime(timestamp) {
            if (!timestamp) return '';

            const msgDate = new Date(timestamp);
            const now = new Date();
            const diffMs = now - msgDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;

            return msgDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function updateDriverList() {
            const team = document.getElementById('teamSelect').value;
            let filtered = team === 'all' ? [...drivers] : drivers.filter(d => d.team === team);

            // Filter by search query
            if (searchQuery) {
                filtered = filtered.filter(d =>
                    d.name.toLowerCase().includes(searchQuery) ||
                    d.phone.includes(searchQuery)
                );
            }

            // Sort based on selected option
            filtered.sort((a, b) => {
                // ALWAYS prioritize unread messages first
                const aUnread = unreadDrivers.has(a.phone);
                const bUnread = unreadDrivers.has(b.phone);

                if (aUnread && !bUnread) return -1;
                if (!aUnread && bUnread) return 1;

                // Sort
                // Sort
                let comparison = 0;
                if (sortBy === 'team') {
                    comparison = a.team.localeCompare(b.team);
                } else if (sortBy === 'myRecent') {
                    // Sort by last message sent by CURRENT USER
                    const timeA = getLastMyMessageTime(a.phone);
                    const timeB = getLastMyMessageTime(b.phone);
                    comparison = timeB - timeA;
                } else if (sortBy === 'name') {
                    comparison = a.name.localeCompare(b.name);
                } else {
                    // Recent (default)
                    const timeA = getLastMessageTime(a.phone);
                    const timeB = getLastMessageTime(b.phone);
                    comparison = timeB - timeA;
                }

                return sortReverse ? -comparison : comparison;
            });

            document.getElementById('driverList').innerHTML = filtered.map(d => {
                const hasUnread = unreadDrivers.has(d.phone);
                const isBlacklisted = blacklistedNumbers.has(d.phone);
                const preview = getLastMessagePreview(d.phone);

                const borderStyle = hasUnread ? `border: 2px solid var(--primary);` : '';

                return `
                    <div class="driver-card p-3 bg-white rounded-lg cursor-pointer ${isBlacklisted ? 'opacity-50' : ''}"
                         style="${borderStyle}"
                         onclick='openConversation(${JSON.stringify(d)})'>
                        <div class="flex justify-between items-start mb-1">
                            <div class="font-semibold text-gray-900 text-sm truncate flex-1">${d.name}</div>
                            <div class="flex gap-1">
                                ${hasUnread ? '<span class="text-xl">üí¨</span>' : ''}
                                ${isBlacklisted ? '<span class="text-sm">üö´</span>' : ''}
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 truncate mb-1">${d.team}</div>
                        ${sortBy === 'recent' || sortBy === 'myRecent' ? `
                            <div class="text-xs ${preview.text === 'No messages yet' ? 'text-gray-400 italic' : 'text-gray-600'} truncate">
                                ${preview.text}
                            </div>
                            ${preview.time ? `<div class="text-xs text-gray-400 mt-1">${preview.time}</div>` : ''}
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        async function openConversation(driver) {
            currentDriver = driver;
            document.getElementById('convName').textContent = driver.name;
            document.getElementById('convPhone').textContent = driver.phone;
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('conversationView').classList.remove('hidden');
            document.getElementById('conversationView').classList.add('flex');
            document.getElementById('resultsSection').classList.add('hidden');

            // Update signature preview
            if (currentUser) {
                document.getElementById('signaturePreview').textContent = getSignature(currentUser);
            }

            unreadDrivers.delete(driver.phone);
            updateDriverList();

            // Clear previous messages immediately to prevent ghosting
            const thread = document.getElementById('messageThread');
            thread.innerHTML = '';

            // Show cached messages immediately if available
            if (conversations[driver.phone] && conversations[driver.phone].length > 0) {
                displayMessages();
            } else {
                // Show loading state
                thread.innerHTML = '<div class="text-center text-gray-500 text-sm"><div class="animate-pulse">Loading conversation history...</div></div>';
            }

            // Fetch latest from Twilio in background
            await fetchConversationHistory(driver.phone);

            displayMessages();
        }

        async function enrichMessagesWithMetadata(messages) {
            if (!messages || messages.length === 0) return;

            const auth = sessionStorage.getItem('auth');
            if (!auth) return;

            // Filter for outbound messages only, as inbound don't have sender metadata (they are from the driver)
            // Actually, we store metadata for ALL messages sent via our platform.
            // But we only care about metadata for OUTBOUND messages (sent by us).
            // Inbound messages (from drivers) don't have a "user" associated in our system in the same way.

            // Collect SIDs
            const sids = messages.map(m => m.sid).join(',');

            if (!sids) return;

            try {
                const metaRes = await apiFetch(`${BACKEND_URL}/api/meta?sids=${sids}`, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });

                if (metaRes.ok) {
                    const metaData = await metaRes.json();
                    // Merge metadata into messages
                    messages.forEach(m => {
                        if (metaData[m.sid]) {
                            m.senderName = metaData[m.sid].user;
                            m.senderColor = metaData[m.sid].color;
                            m.isBulk = metaData[m.sid].isBulk; // Load bulk flag
                        }
                    });
                }
            } catch (e) {
                console.error('Error fetching metadata:', e);
            }
        }

        async function fetchConversationHistory(phone) {
            const auth = sessionStorage.getItem('auth');
            if (!auth) return;

            try {
                // Optimization: Fetch inbound and outbound messages in parallel using Backend Proxy
                const [inboundRes, outboundRes] = await Promise.all([
                    apiFetch(`${BACKEND_URL}/api/messages?PageSize=50&From=${encodeURIComponent(phone)}`, {
                        headers: { 'Authorization': `Basic ${auth}` }
                    }),
                    apiFetch(`${BACKEND_URL}/api/messages?PageSize=50&To=${encodeURIComponent(phone)}`, {
                        headers: { 'Authorization': `Basic ${auth}` }
                    })
                ]);

                let newMessages = [];

                if (inboundRes.ok) {
                    const data = await inboundRes.json();
                    newMessages = newMessages.concat(data.messages);
                }
                if (outboundRes.ok) {
                    const data = await outboundRes.json();
                    newMessages = newMessages.concat(data.messages);
                }

                // Initialize conversation if needed
                if (!conversations[phone]) {
                    conversations[phone] = [];
                }

                // Filter out messages we already have to avoid re-processing
                const trulyNewMessages = newMessages.filter(m => !conversations[phone].find(existing => existing.sid === m.sid));

                if (trulyNewMessages.length === 0) {
                    console.log('No new messages found');
                    return;
                }

                console.log(`Found ${trulyNewMessages.length} new messages`);

                // Fetch metadata for new messages
                await enrichMessagesWithMetadata(trulyNewMessages);

                // Process media for new messages
                for (const m of trulyNewMessages) {
                    // Get media URLs if present
                    const mediaUrls = [];
                    if (m.num_media && parseInt(m.num_media) > 0) {
                        // Media fetching skipped for now as it requires another proxy endpoint
                        // We can add /api/media-list later
                    }

                    // Add to conversation
                    conversations[phone].push({
                        sid: m.sid,
                        body: m.body || (mediaUrls.length > 0 ? 'üì∑ Image' : ''),
                        direction: m.direction,
                        timestamp: m.date_created,
                        media: mediaUrls,
                        senderName: m.senderName,
                        senderColor: m.senderColor,
                        isBulk: m.isBulk // Persist bulk flag
                    });

                    // Check for STOP message
                    if (m.direction === 'inbound' && m.body && m.body.trim().toUpperCase() === 'STOP') {
                        blacklistedNumbers.add(phone);
                        saveBlacklist();
                        console.log(`Added ${phone} to blacklist`);
                    }
                }

                // Save to cache
                saveCachedConversations();

                console.log(`Loaded ${newMessages.length} messages for ${phone}`);

            } catch (err) {
                console.error('Error fetching conversation history:', err);
            }
        }

        function closeConversation() {
            currentDriver = null;
            document.getElementById('conversationView').classList.add('hidden');
            document.getElementById('conversationView').classList.remove('flex');
            document.getElementById('emptyState').classList.remove('hidden');
        }

        async function getAuthenticatedMediaUrl(mediaUrl) {
            // If it's not a Twilio URL, return as-is (e.g., ImgBB URLs don't need auth)
            if (!mediaUrl.includes('api.twilio.com')) {
                console.log('Non-Twilio URL, returning as-is:', mediaUrl.substring(0, 50) + '...');
                return mediaUrl;
            }

            // Check cache first
            if (mediaCache[mediaUrl]) {
                console.log('Using cached media for:', mediaUrl.substring(0, 50) + '...');
                return mediaCache[mediaUrl];
            }

            console.log('Fetching authenticated Twilio media:', mediaUrl.substring(0, 50) + '...');

            const sid = document.getElementById('accountSid').value;
            const token = document.getElementById('authToken').value;

            try {
                // Fetch the media with authentication
                const response = await fetch(mediaUrl, {
                    headers: {
                        'Authorization': 'Basic ' + btoa(sid + ':' + token)
                    }
                });

                if (!response.ok) {
                    console.error('Failed to fetch media, status:', response.status);
                    throw new Error('Failed to fetch media');
                }

                // Convert to blob and create object URL
                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);

                // Cache it
                mediaCache[mediaUrl] = objectUrl;

                console.log('Successfully created blob URL for Twilio media');
                return objectUrl;
            } catch (err) {
                console.error('Error fetching media:', err);
                // Fallback: return the original URL so the user can at least try to open it
                return mediaUrl;
            }
        }

        async function displayMessages() {
            const thread = document.getElementById('messageThread');
            // Capture the driver we are trying to display messages for
            const targetDriver = currentDriver;

            if (!targetDriver) return;

            const msgs = conversations[targetDriver.phone] || [];
            const hideBulk = document.getElementById('hideBulkToggle')?.checked;

            if (msgs.length === 0) {
                thread.innerHTML = '<p class="text-center text-gray-500 text-sm">No messages yet</p>';
                return;
            }

            // Filter messages if needed
            let displayMsgs = msgs;
            if (hideBulk) {
                displayMsgs = msgs.filter(m => !m.isBulk);
            }

            if (displayMsgs.length === 0) {
                thread.innerHTML = '<p class="text-center text-gray-500 text-sm">No messages (Bulk hidden)</p>';
                return;
            }

            const sortedMsgs = [...displayMsgs].sort((a, b) => {
                const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                return timeA - timeB;
            });

            // Pre-fetch authenticated media URLs (only for Twilio URLs)
            const authenticatedMsgs = await Promise.all(sortedMsgs.map(async (m) => {
                if (m.media && m.media.length > 0) {
                    const authenticatedMedia = await Promise.all(
                        m.media.map(url => getAuthenticatedMediaUrl(url))
                    );
                    // Filter out failed fetches (nulls)
                    return { ...m, authenticatedMedia: authenticatedMedia.filter(url => url !== null) };
                }
                return m;
            }));

            // CRITICAL: Check if the user has switched drivers while we were fetching media
            if (!currentDriver || currentDriver.phone !== targetDriver.phone) {
                console.log('Driver switched during render, aborting displayMessages');
                return;
            }

            thread.innerHTML = authenticatedMsgs.map(m => {
                const isSent = m.direction === 'outbound-api';

                // Determine bubble color:
                // 1. Try to find the sender in the current user list (dynamic update)
                // 2. Fallback to stored senderColor (historical)
                // 3. Default to primary color
                let bubbleColor = 'var(--primary)';
                if (isSent) {
                    if (m.senderName) {
                        const senderUser = users.find(u => u.username === m.senderName);
                        if (senderUser && senderUser.color) {
                            bubbleColor = senderUser.color;
                        } else if (m.senderColor) {
                            bubbleColor = m.senderColor;
                        }
                    } else if (m.senderColor) {
                        bubbleColor = m.senderColor;
                    }
                }

                const bubbleStyle = isSent ? `background-color: ${bubbleColor}; color: white;` : '';
                const hasMedia = m.authenticatedMedia && m.authenticatedMedia.length > 0;

                // Format timestamp
                const timestamp = m.timestamp ? new Date(m.timestamp).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                }) : '';

                return `
                    <div class="flex ${isSent ? 'justify-end' : 'justify-start'} flex-col ${isSent ? 'items-end' : 'items-start'} mb-3">
                        <div class="${isSent ? 'text-white' : 'bg-white border-2'} rounded-2xl px-4 py-2 max-w-md" style="${bubbleStyle}">
                            ${hasMedia ? m.authenticatedMedia.map((url, idx) => `
                                <img src="${url}" 
                                     class="rounded-lg mb-2 max-w-full cursor-pointer" 
                                     onclick="window.open('${url}', '_blank')" 
                                     style="max-height: 300px;"
                                     onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<a href=\\'${url}\\' target=\\'_blank\\' class=\\'text-blue-500 underline text-sm block mb-2\\'>‚ö†Ô∏è Unable to load image - Click to view</a>');">
                            `).join('') : ''}
                            ${m.body ? `<div>${m.body}</div>` : ''}
                        </div>
                        <div class="flex items-center gap-2 mt-1 px-2">
                            ${isSent && m.senderName ? `<span class="text-xs font-medium text-gray-500">${m.senderName}</span>` : ''}
                            ${m.isBulk ? `<span class="text-xs font-bold text-blue-500 bg-blue-50 px-1 rounded">BULK</span>` : ''}
                            ${timestamp ? `<span class="text-xs text-gray-400">${timestamp}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            thread.scrollTop = thread.scrollHeight;
        }

        async function sendReply() {
            let msg = document.getElementById('replyInput').value.trim();
            const hasImage = selectedImage !== null;

            if (!msg && !hasImage) return;
            if (!currentDriver) return;

            // Add signature if checked
            const addSig = document.getElementById('addSignature').checked;
            if (addSig && currentUser) {
                msg = msg + '\n\n' + getSignature(currentUser);
            }

            try {
                let mediaUrl = null;

                // Upload image if present (still need SID/token for this)
                if (hasImage) {
                    // We need to get credentials for image upload
                    // For now, let's skip image support or handle it differently
                    alert('Image upload not yet supported with secure credentials. Coming soon!');
                    return;
                }

                const auth = sessionStorage.getItem('auth');
                if (!auth) {
                    alert('Please log in first');
                    return;
                }

                // Use backend proxy
                const res = await apiFetch(`${BACKEND_URL}/api/send-message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Basic ${auth}`
                    },
                    body: JSON.stringify({
                        to: currentDriver.phone,
                        body: msg,
                        mediaUrl: mediaUrl
                    })
                });

                if (res.ok) {
                    const data = await res.json();

                    // Add to local conversation
                    if (!conversations[currentDriver.phone]) conversations[currentDriver.phone] = [];
                    if (!conversations[currentDriver.phone].find(m => m.sid === data.sid)) {
                        conversations[currentDriver.phone].push({
                            sid: data.sid,
                            body: msg || 'üì∑ Image',
                            direction: 'outbound-api',
                            timestamp: data.date_created || new Date().toISOString(),
                            media: mediaUrl ? [mediaUrl] : [],
                            senderName: currentUser || 'Unknown',
                            senderColor: currentUserColor
                        });
                    }
                    document.getElementById('replyInput').value = '';
                    clearImagePreview();
                    displayMessages();
                    updateDriverList();
                } else {
                    const error = await res.json();
                    alert('Failed to send: ' + (error.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
                console.error(err);
            }
        }

        async function uploadImageToTwilio(file, sid, token) {
            // Upload image to ImgBB (free image hosting service)
            // Get your free API key from https://api.imgbb.com/
            const IMGBB_API_KEY = '637a3db78161b8f5b8b934242dafd4a4'; // ‚ö†Ô∏è REPLACE THIS WITH YOUR API KEY

            if (IMGBB_API_KEY === 'YOUR_IMGBB_API_KEY_HERE') {
                throw new Error('Please configure your ImgBB API key in the code. Get one free at https://api.imgbb.com/');
            }

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const base64 = e.target.result.split(',')[1]; // Remove data URL prefix

                        // Upload to ImgBB
                        const formData = new FormData();
                        formData.append('image', base64);

                        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            throw new Error('Failed to upload image to hosting service');
                        }

                        const data = await response.json();

                        if (data.success) {
                            // Return the publicly accessible URL
                            resolve(data.data.url);
                        } else {
                            throw new Error('Image upload failed');
                        }
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function pollMessages() {
            const auth = sessionStorage.getItem('auth');
            if (!auth) return;

            try {
                // Only fetch recent messages (last 100) to check for new activity
                // Use backend proxy
                const res = await apiFetch(`${BACKEND_URL}/api/messages?PageSize=100`, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    let hasNewMessages = false;

                    // Changed from forEach to for...of to support async operations
                    for (const m of data.messages) {
                        const phone = m.direction === 'inbound' ? m.from : m.to;

                        if (!conversations[phone]) {
                            conversations[phone] = [];
                            lastMessageCount[phone] = 0;
                        }

                        // Check if message already exists
                        if (!conversations[phone].find(x => x.sid === m.sid)) {
                            // Fetch metadata for this single new message
                            // We create a temporary array to reuse the helper
                            const tempArray = [m];
                            await enrichMessagesWithMetadata(tempArray);
                            // m is now enriched (modified in place)

                            // Get media URLs if present - FIXED VERSION
                            const mediaUrls = [];
                            if (m.num_media && parseInt(m.num_media) > 0) {
                                console.log(`Message ${m.sid} has ${m.num_media} media items, fetching...`);

                                try {
                                    // Fetch the media subresource for this message
                                    // Note: Media fetching still requires direct Twilio access for now, or a separate proxy.
                                    // But since we don't have credentials in frontend, we might need to skip this or implement /api/media
                                    // For now, let's just log that we found media but can't fetch details yet without a proxy.
                                    console.log('Media detected. Fetching media details via proxy is not yet implemented.');

                                    /* 
                                    // TODO: Implement /api/media-list proxy to fetch this
                                    const mediaRes = await fetch(
                                        `https://api.twilio.com/2010-04-01/Accounts/${sid}/Messages/${m.sid}/Media.json`,
                                        { headers: { 'Authorization': 'Basic ' + btoa(sid + ':' + token) } }
                                    );
                                    */

                                    if (mediaRes.ok) {
                                        const mediaData = await mediaRes.json();
                                        console.log(`Found ${mediaData.media_list.length} media items`);

                                        // Extract media URLs from the media list
                                        mediaData.media_list.forEach(media => {
                                            if (media.uri) {
                                                // Convert the relative URI to full URL
                                                const fullUrl = `https://api.twilio.com${media.uri.replace('.json', '')}`;
                                                mediaUrls.push(fullUrl);
                                                console.log('Added media URL:', fullUrl);
                                            }
                                        });
                                    } else {
                                        console.error('Failed to fetch media list:', mediaRes.status);
                                    }
                                } catch (mediaErr) {
                                    console.error('Error fetching media for message:', mediaErr);
                                }
                            }

                            conversations[phone].push({
                                sid: m.sid,
                                body: m.body || (mediaUrls.length > 0 ? 'üì∑ Image' : ''),
                                direction: m.direction,
                                timestamp: m.date_created,
                                media: mediaUrls
                            });

                            // Check for STOP message
                            if (m.direction === 'inbound' && m.body && m.body.trim().toUpperCase() === 'STOP') {
                                blacklistedNumbers.add(phone);
                                saveBlacklist();
                                console.log(`Added ${phone} to blacklist via poll`);
                                updateDriverList();
                            }

                            // If it's an inbound message and not from current open conversation
                            if (m.direction === 'inbound' && (!currentDriver || currentDriver.phone !== phone)) {
                                unreadDrivers.add(phone);
                                hasNewMessages = true;

                                console.log('New inbound message detected from:', phone);

                                // Find driver name for notification
                                let driver = drivers.find(d => d.phone === phone);

                                // If driver doesn't exist, create an ad-hoc contact
                                if (!driver) {
                                    console.log('Unknown number, creating ad-hoc contact:', phone);
                                    driver = {
                                        id: 'adhoc-' + Date.now(),
                                        name: phone, // Use phone as name initially
                                        firstName: phone.substring(0, 10),
                                        phone: phone,
                                        team: 'üì± Ad-Hoc Contacts',
                                        isAdHoc: true
                                    };

                                    drivers.push(driver);

                                    // Add team if it doesn't exist
                                    if (!teams.includes('üì± Ad-Hoc Contacts')) {
                                        teams.push('üì± Ad-Hoc Contacts');
                                        updateTeamOptions();
                                    }

                                    saveAdHocContacts();
                                }

                                if (driver) {
                                    const notifText = m.body || (mediaUrls.length > 0 ? 'üì∑ Sent an image' : 'New message');
                                    showNotification(driver.name, notifText);
                                }
                            }
                        }
                    }

                    // Save conversations to cache
                    saveCachedConversations();

                    if (hasNewMessages) {
                        console.log('Playing notification sound for new messages');
                        playNotificationSound();
                    }

                    if (currentDriver) displayMessages();
                    updateDriverList();
                }
            } catch (err) {
                console.error('Poll error:', err);
            }
        }

        function showNotification(driverName, messageText) {
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(`New message from ${driverName}`, {
                    body: messageText.substring(0, 100),
                    icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üí¨</text></svg>"
                });
            }
        }

        function playNotificationSound() {
            if (notificationSoundPreference === 'none') {
                return;
            }

            console.log('Playing notification sound:', notificationSoundPreference);

            if (typeof window[notificationSoundPreference] === 'function') {
                try {
                    window[notificationSoundPreference]();
                } catch (e) {
                    console.error('Error playing sound:', e);
                }
            } else {
                console.error('Sound function not found:', notificationSoundPreference);
                playTrill(); // Fallback to default
            }
        }

        function playBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playTrill() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.2);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.25, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playDing() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 2000;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playWhoosh() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(1500, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + 0.15);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playPop() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'square';

                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.08);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.08);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playPluck() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 330;
                oscillator.type = 'triangle';

                gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playAlertTone() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                [0, 0.15, 0.3].forEach((delay, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.value = 1000;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.25, audioContext.currentTime + delay);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + delay + 0.1);
                    osc.start(audioContext.currentTime + delay);
                    osc.stop(audioContext.currentTime + delay + 0.1);
                });
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playSoftPing() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 880;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playDoubleBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);
                osc1.frequency.value = 800;
                osc1.type = 'sine';
                gain1.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                osc1.start(audioContext.currentTime);
                osc1.stop(audioContext.currentTime + 0.1);

                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.frequency.value = 1000;
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.3, audioContext.currentTime + 0.15);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
                osc2.start(audioContext.currentTime + 0.15);
                osc2.stop(audioContext.currentTime + 0.25);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playChime() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 1200;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playBubble() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.1);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playQuiet() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 440;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function showBulkModal() {
            console.log('showBulkModal called');
            console.log('Drivers loaded:', drivers.length);
            console.log('Teams:', teams);

            if (drivers.length === 0) {
                alert('Please load drivers first!');
                return;
            }

            const select = document.getElementById('bulkTeamSelect');
            if (!select) {
                console.error('bulkTeamSelect not found!');
                return;
            }

            select.innerHTML = teams.map(t => {
                const count = t === 'all' ? drivers.length : drivers.filter(d => d.team === t).length;
                return `<option value="${t}">${t === 'all' ? 'üåç All Teams' : t} (${count})</option>`;
            }).join('');

            // Update signature preview
            if (currentUser) {
                document.getElementById('bulkSignaturePreview').textContent = getSignature(currentUser);
            }

            updateBulkList();

            const modal = document.getElementById('bulkModal');
            if (modal) {
                modal.classList.remove('hidden');
                console.log('Modal opened');
            } else {
                console.error('bulkModal element not found!');
            }

            setTimeout(() => updateBulkPreview(), 100);
        }

        function closeBulkModal() {
            document.getElementById('bulkModal').classList.add('hidden');
        }

        function showNewMessageModal() {
            document.getElementById('newMessageModal').classList.remove('hidden');
            document.getElementById('newPhone').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newPhone').focus();
        }

        function closeNewMessageModal() {
            document.getElementById('newMessageModal').classList.add('hidden');
        }

        function startNewConversation() {
            const phone = document.getElementById('newPhone').value.trim();
            const name = document.getElementById('newName').value.trim() || phone;

            if (!phone) {
                alert('Please enter a phone number');
                return;
            }

            // Basic validation - must start with + and have at least 10 digits
            if (!phone.startsWith('+')) {
                alert('Phone number must include country code (e.g., +1234567890)');
                return;
            }

            if (phone.replace(/[^0-9]/g, '').length < 10) {
                alert('Please enter a valid phone number');
                return;
            }

            // Check if this contact already exists
            let existingDriver = drivers.find(d => d.phone === phone);

            if (!existingDriver) {
                // Add as a new "ad-hoc" driver
                const newDriver = {
                    id: 'adhoc-' + Date.now(),
                    name: name,
                    firstName: name.split(' ')[0],
                    phone: phone,
                    team: 'üì± Ad-Hoc Contacts',
                    isAdHoc: true
                };

                drivers.push(newDriver);

                // Add team if it doesn't exist
                if (!teams.includes('üì± Ad-Hoc Contacts')) {
                    teams.push('üì± Ad-Hoc Contacts');
                    updateTeamOptions();
                }

                // Save to localStorage
                saveAdHocContacts();

                existingDriver = newDriver;
                updateDriverList();
            }

            // Open conversation with this contact
            closeNewMessageModal();
            openConversation(existingDriver);
        }

        function updateBulkList() {
            const team = document.getElementById('bulkTeamSelect').value;
            const filtered = team === 'all' ? drivers : drivers.filter(d => d.team === team);

            selectedDriverIds.clear();
            filtered.forEach(d => selectedDriverIds.add(d.id));

            document.getElementById('bulkDriverList').innerHTML = filtered.map(d => `
                <div class="flex items-center p-2 mb-2 bg-white rounded-lg">
                    <input type="checkbox" id="bulk-${d.id}" checked onchange="toggleBulk(${d.id})" class="w-5 h-5">
                    <label for="bulk-${d.id}" class="ml-3 flex-1 cursor-pointer text-sm">
                        <div class="font-medium">${d.name}</div>
                        <div class="text-xs text-gray-500">${d.phone}</div>
                    </label>
                </div>
            `).join('');

            updateBulkCount();
            updateBulkPreview();
        }

        function toggleBulk(id) {
            if (selectedDriverIds.has(id)) {
                selectedDriverIds.delete(id);
            } else {
                selectedDriverIds.add(id);
            }
            updateBulkCount();
            updateBulkPreview();
        }

        function selectAllBulk() {
            const team = document.getElementById('bulkTeamSelect').value;
            const filtered = team === 'all' ? drivers : drivers.filter(d => d.team === team);
            filtered.forEach(d => {
                selectedDriverIds.add(d.id);
                const cb = document.getElementById(`bulk-${d.id}`);
                if (cb) cb.checked = true;
            });
            updateBulkCount();
            updateBulkPreview();
        }

        function deselectAllBulk() {
            const team = document.getElementById('bulkTeamSelect').value;
            const filtered = team === 'all' ? drivers : drivers.filter(d => d.team === team);
            filtered.forEach(d => {
                selectedDriverIds.delete(d.id);
                const cb = document.getElementById(`bulk-${d.id}`);
                if (cb) cb.checked = false;
            });
            updateBulkCount();
            updateBulkPreview();
        }

        function updateBulkCount() {
            const count = selectedDriverIds.size;
            document.getElementById('bulkCount').textContent = `${count} selected ‚Ä¢ Est. $${(count * 0.0079).toFixed(2)}`;
        }

        function updateBulkPreview() {
            const msg = document.getElementById('bulkMessage').value.trim();
            const addSig = document.getElementById('bulkAddSignature').checked;
            const previewBox = document.getElementById('bulkPreviewBox');
            const previewText = document.getElementById('bulkPreviewText');

            if (!msg) {
                previewBox.classList.add('hidden');
                return;
            }

            const firstSelectedId = Array.from(selectedDriverIds)[0];
            const firstDriver = drivers.find(d => d.id === firstSelectedId);

            if (!firstDriver) {
                // If no driver selected, just show raw message
                previewText.textContent = msg;
                previewBox.classList.remove('hidden');
                return;
            }

            let personalizedMsg = msg.replace(/{firstName}/g, firstDriver.firstName)
                .replace(/{name}/g, firstDriver.name)
                .replace(/{team}/g, firstDriver.team);

            if (addSig && currentUser) {
                personalizedMsg += '\n\n' + getSignature(currentUser);
            }

            // Always add Team Message footer
            personalizedMsg += '\n\n(Team message.)';

            previewText.textContent = personalizedMsg;
            previewBox.classList.remove('hidden');
        }

        function getSignature(username) {
            const user = users.find(u => u.username === username);
            if (!user) return '- ' + username;

            let parts = [username];
            if (user.role && user.role !== 'User') parts.push(user.role);

            // Use user's company or fallback to global company name
            const company = user.company || globalCompanyName;
            if (company) parts.push(company);

            return '- ' + parts.join(', ');
        }

        async function saveSettings() {
            // Save user preferences (notification sound) - available to all users
            const soundPref = document.querySelector('input[name="notificationSound"]:checked')?.value;
            if (soundPref) {
                localStorage.setItem('notificationSound', soundPref);
            }

            // Only try to save admin settings if fields are filled
            const sid = document.getElementById('accountSid').value.trim();
            const token = document.getElementById('authToken').value.trim();
            const number = document.getElementById('twilioNumber').value.trim();
            const company = document.getElementById('companyNameSettings').value.trim();

            // If admin fields are filled, save them (admin only)
            if (sid || token || number || company) {
                if (!sid || !token || !number) {
                    alert('Please fill in all Twilio fields (SID, Token, and Number)');
                    return;
                }

                try {
                    const auth = sessionStorage.getItem('auth');
                    const res = await fetch(`${BACKEND_URL}/api/settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Basic ${auth}`
                        },
                        body: JSON.stringify({ sid, token, number, company })
                    });

                    if (res.ok) {
                        updateHeaderTitle(company);
                        lockAdminFields(); // Re-lock after save
                        alert('‚úÖ Settings saved securely!');
                    } else {
                        const errorText = await res.text();
                        // Check if it's a forbidden error (non-admin trying to save)
                        if (errorText.includes('Forbidden') || errorText.includes('Admin only')) {
                            alert('‚ö†Ô∏è User preferences saved!\n\n(Only Admins can save Twilio settings)');
                        } else {
                            alert('Failed to save admin settings: ' + errorText);
                        }
                    }
                } catch (e) {
                    alert('Error saving admin settings: ' + e.message);
                }
            } else {
                // Only user preferences were saved
                alert('‚úÖ Notification preferences saved!');
            }

            closeSettings();
        }

        async function testConnection() {
            const sid = document.getElementById('accountSid').value.trim();
            const token = document.getElementById('authToken').value.trim();
            const btn = document.getElementById('testConnectionBtn');
            const result = document.getElementById('testConnectionResult');

            if (!sid || !token) {
                alert('Please enter SID and Token first');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Testing...';
            result.classList.add('hidden');

            try {
                const auth = sessionStorage.getItem('auth');
                const res = await fetch(`${BACKEND_URL}/api/test-connection`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Basic ${auth}`
                    },
                    body: JSON.stringify({ sid, token })
                });

                const data = await res.json();

                result.classList.remove('hidden');
                if (data.success) {
                    result.innerHTML = `<span class="text-green-600 font-bold">‚úÖ Success! Connected to: ${data.accountName}</span>`;
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    btn.classList.add('bg-green-100', 'text-green-700');
                } else {
                    result.innerHTML = `<span class="text-red-600 font-bold">‚ùå Failed: ${data.error}</span>`;
                    btn.classList.remove('bg-green-100', 'text-green-700');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            } catch (e) {
                result.classList.remove('hidden');
                result.innerHTML = `<span class="text-red-600 font-bold">‚ùå Error: ${e.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîå Test Connection';
            }
        }

        function updateHeaderTitle(company) {
            const titleEl = document.getElementById('appHeaderTitle');
            if (company) {
                titleEl.innerHTML = `üí¨ ${company} SMS Manager <span class="text-sm text-gray-400">v2.2.0</span>`;
            } else {
                titleEl.innerHTML = `üí¨ Driver SMS Manager <span class="text-sm text-gray-400">v2.2.0</span>`;
            }
        }

        function loadCredentials() {
            const sid = localStorage.getItem('twilio_sid');
            const token = localStorage.getItem('twilio_token');
            const number = localStorage.getItem('twilio_number');
            const company = localStorage.getItem('company_name');

            if (sid) document.getElementById('accountSid').value = sid;
            if (token) document.getElementById('authToken').value = token;
            if (number) document.getElementById('twilioNumber').value = number;
            if (company) document.getElementById('companyNameSettings').value = company;

            updateHeaderTitle();
        }

        async function sendBulk() {
            const msg = document.getElementById('bulkMessage').value.trim();
            const addSig = document.getElementById('bulkAddSignature').checked;

            if (!msg) {
                alert('Enter a message');
                return;
            }

            let selected = drivers.filter(d => selectedDriverIds.has(d.id));

            // Filter out blacklisted numbers
            const blacklisted = selected.filter(d => blacklistedNumbers.has(d.phone));
            selected = selected.filter(d => !blacklistedNumbers.has(d.phone));

            if (selected.length === 0) {
                alert('No drivers selected or all selected drivers are blacklisted');
                return;
            }

            let confirmMsg = `Send to ${selected.length} drivers?\nCost: ~${(selected.length * 0.0079).toFixed(2)}`;
            if (blacklisted.length > 0) {
                confirmMsg += `\n\n‚ö†Ô∏è ${blacklisted.length} blacklisted driver(s) will be skipped:\n${blacklisted.map(d => d.name).join(', ')}`;
            }

            if (!confirm(confirmMsg)) return;

            const auth = sessionStorage.getItem('auth');
            if (!auth) {
                alert('Please log in first');
                return;
            }

            closeBulkModal();
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('conversationView').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultsList').innerHTML = '';

            let success = 0, fail = 0;

            // Show skipped drivers
            if (blacklisted.length > 0) {
                blacklisted.forEach(d => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'p-4 rounded-xl bg-gray-100 border-2 border-gray-300';
                    resultDiv.innerHTML = `<span class="text-2xl">üö´</span> <strong>${d.name}</strong> - Skipped (Blacklisted)`;
                    document.getElementById('resultsList').appendChild(resultDiv);
                });
            }

            for (const d of selected) {
                let personalizedMsg = msg.replace(/{firstName}/g, d.firstName)
                    .replace(/{name}/g, d.name)
                    .replace(/{team}/g, d.team);

                if (addSig && currentUser) {
                    personalizedMsg += '\n\n' + getSignature(currentUser);
                }

                // Always add Team Message footer
                personalizedMsg += '\n\n(Team message.)';

                try {
                    // Use backend proxy
                    const res = await fetch(`${BACKEND_URL}/api/send-message`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Basic ${auth}`
                        },
                        body: JSON.stringify({
                            to: d.phone,
                            body: personalizedMsg,
                            isBulk: true // Flag as bulk
                        })
                    });

                    const resultDiv = document.createElement('div');
                    if (res.ok) {
                        success++;
                        resultDiv.className = 'p-4 rounded-xl bg-green-50 border-2 border-green-200';
                        resultDiv.innerHTML = `<span class="text-2xl">‚úÖ</span> <strong>${d.name}</strong> - Sent`;

                        const responseData = await res.json();

                        // Add to local conversation
                        if (!conversations[d.phone]) conversations[d.phone] = [];
                        if (!conversations[d.phone].find(m => m.sid === responseData.sid)) {
                            conversations[d.phone].push({
                                sid: responseData.sid,
                                body: personalizedMsg,
                                direction: 'outbound-api',
                                timestamp: responseData.date_created || new Date().toISOString(),
                                senderName: currentUser,
                                senderColor: currentUserColor || '#667eea',
                                isBulk: true
                            });
                        }
                    } else {
                        fail++;
                        const error = await res.json();
                        resultDiv.className = 'p-4 rounded-xl bg-red-50 border-2 border-red-200';
                        resultDiv.innerHTML = `<span class="text-2xl">‚ùå</span> <strong>${d.name}</strong> - Failed: ${error.error || 'Unknown error'}`;
                    }
                    document.getElementById('resultsList').appendChild(resultDiv);
                } catch (err) {
                    fail++;
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'p-4 rounded-xl bg-red-50 border-2 border-red-200';
                    resultDiv.innerHTML = `<span class="text-2xl">‚ùå</span> <strong>${d.name}</strong> - Error: ${err.message}`;
                    document.getElementById('resultsList').appendChild(resultDiv);
                }
            }

            document.getElementById('successCount').textContent = success;
            document.getElementById('failCount').textContent = fail;
            saveConversations();
            updateDriverList();
        }

        // ========== USER MANAGEMENT FUNCTIONS ==========

        async function showUserManagement() {
            document.getElementById('userManagementModal').classList.remove('hidden');
            await loadUsers();
        }

        function closeUserManagement() {
            document.getElementById('userManagementModal').classList.add('hidden');
            resetUserForm(); // Reset form when closing
        }

        async function loadUsers() {
            const list = document.getElementById('userList');
            list.innerHTML = '<p class="text-center text-gray-500 text-sm py-8">Loading...</p>';

            try {
                const auth = sessionStorage.getItem('auth');
                const res = await fetch(`${BACKEND_URL}/api/users`, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.users && data.users.length > 0) {
                        // Update global users list
                        users = data.users;

                        // Update current user theme if found
                        const myUser = users.find(u => u.username === currentUser);
                        if (myUser) {
                            if (myUser.color) {
                                currentUserColor = myUser.color;
                                applyUserTheme(myUser.color);
                            }
                            if (myUser.role) {
                                currentUserRole = myUser.role;
                            }
                        }

                        list.innerHTML = data.users.map(u => `
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border-2 border-gray-200">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs" style="background-color: ${u.color || '#667eea'}">
                                ${u.username.substring(0, 2).toUpperCase()}
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">${u.username}</div>
                                <div class="text-xs text-gray-500">${u.role || 'User'}${u.company ? `, ${u.company}` : ''}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="editUser('${u.username}', '${u.role || 'User'}', '${u.color || '#667eea'}', '${u.company || ''}')" class="text-blue-500 hover:text-blue-700 p-2" title="Edit">
                                ‚úèÔ∏è
                            </button>
                            ${u.username !== currentUser ? `
                                <button onclick="deleteUser('${u.username}')" class="text-red-500 hover:text-red-700 p-2" title="Delete">
                                    üóëÔ∏è
                                </button>
                            ` : '<span class="text-xs text-gray-400 italic">You</span>'}
                        </div>
                    </div>
                `).join('');
                    } else {
                        list.innerHTML = '<p class="text-center text-gray-500 text-sm py-8">No users found.</p>';
                    }
                } else {
                    list.innerHTML = '<p class="text-center text-red-500 text-sm py-8">Failed to load users.</p>';
                }
            } catch (e) {
                console.error(e);
                list.innerHTML = '<p class="text-center text-red-500 text-sm py-8">Error loading users.</p>';
            }
        }
        async function addUser() {
            const username = document.getElementById('newUserName').value.trim();
            const password = document.getElementById('newUserPass').value.trim();
            const role = document.getElementById('newUserRole').value;
            const company = document.getElementById('newUserCompany').value.trim();
            const color = document.getElementById('newUserColor').value;
            const isEdit = document.getElementById('newUserName').disabled;

            if (!username) {
                alert('Please enter username');
                return;
            }

            // If adding new user (username not disabled), password is required
            if (!isEdit && !password) {
                alert('Please enter password');
                return;
            }

            // If editing and password is empty, don't send it (keep existing)
            const payload = { username, role, color, company };
            if (password) payload.password = password;

            try {
                const auth = sessionStorage.getItem('auth');
                const res = await fetch(`${BACKEND_URL}/api/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Basic ${auth}`
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert(`‚úÖ User ${username} ${isEdit ? 'updated' : 'added'}!`);
                    resetUserForm();
                    loadUsers();
                } else {
                    const errorData = await res.json();
                    alert('Failed to save user: ' + (errorData.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function editUser(username, role, color, company) {
            document.getElementById('formTitle').textContent = 'Edit User';
            document.getElementById('newUserName').value = username;
            document.getElementById('newUserName').disabled = true; // Cannot change username
            document.getElementById('newUserPass').placeholder = '(Leave blank to keep current)';
            document.getElementById('newUserRole').value = role;
            document.getElementById('newUserCompany').value = company || '';
            selectColor(null, color); // Pass null for button, as we're just setting the value and visual
            document.getElementById('addUserBtn').textContent = 'üíæ Update User';
            document.getElementById('addUserBtn').classList.remove('bg-primary');
            document.getElementById('addUserBtn').classList.add('bg-green-600');
            document.getElementById('cancelEditBtn').classList.remove('hidden');
        }

        function resetUserForm() {
            document.getElementById('formTitle').textContent = 'Add New User';
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserName').disabled = false;
            document.getElementById('newUserPass').value = '';
            document.getElementById('newUserPass').placeholder = 'e.g., secret123';
            document.getElementById('newUserRole').value = 'User';
            document.getElementById('newUserCompany').value = '';
            selectColor(null, '#4f46e5'); // Reset to default color

            const addBtn = document.getElementById('addUserBtn');
            if (addBtn) {
                addBtn.textContent = '‚ûï Add User';
                addBtn.classList.remove('bg-green-600');
                addBtn.classList.add('bg-primary');
            }

            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.classList.add('hidden');
            }
        }

        async function deleteUser(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"?`)) return;

            try {
                const auth = sessionStorage.getItem('auth');
                const res = await fetch(`${BACKEND_URL}/api/users?username=${encodeURIComponent(username)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Basic ${auth}` }
                });

                if (res.ok) {
                    loadUsers();
                } else {
                    const data = await res.json();
                    alert('Failed to delete user: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function selectColor(btn, color) {
            // Update hidden input
            document.getElementById('newUserColor').value = color;

            // Update visual selection
            const buttons = document.getElementById('colorPalette').getElementsByTagName('button');
            for (let b of buttons) {
                b.classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500');
            }

            if (btn) {
                btn.classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');
            }
        }
        // ========== CALL FUNCTIONS ==========

        function initiateCall() {
            const phone = document.getElementById('convPhone').textContent;
            const name = document.getElementById('convName').textContent;

            if (!phone) return;

            document.getElementById('callCustomerName').textContent = name;
            document.getElementById('callCustomerNumber').textContent = phone;

            // Load saved number
            const savedNum = localStorage.getItem('my_personal_number');
            if (savedNum) {
                document.getElementById('myPhoneNumber').value = savedNum;
            }

            document.getElementById('callModal').classList.remove('hidden');
            // Focus input if empty
            if (!savedNum) {
                setTimeout(() => document.getElementById('myPhoneNumber').focus(), 100);
            }
        }

        function closeCallModal() {
            document.getElementById('callModal').classList.add('hidden');
        }

        async function performCall() {
            const myPhone = document.getElementById('myPhoneNumber').value.trim();
            const customerPhone = document.getElementById('callCustomerNumber').textContent.trim();

            if (!myPhone) {
                alert('Please enter your phone number');
                return;
            }

            // Save for next time
            localStorage.setItem('my_personal_number', myPhone);

            const btn = document.getElementById('performCallBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span> Calling you...';

            try {
                const auth = sessionStorage.getItem('auth');
                const res = await fetch(`${BACKEND_URL}/api/make-call`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Basic ${auth}`
                    },
                    body: JSON.stringify({
                        userPhone: myPhone,
                        customerPhone: customerPhone
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    alert('‚úÖ Call initiated! Pick up your phone.');
                    closeCallModal();
                } else {
                    alert('‚ùå Call Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            // checkSavedLogin(); // No longer needed with new auth

            // Load users if authenticated (to get company info for signatures)
            if (sessionStorage.getItem('auth')) {
                loadUsers();
            }
        });
    </script>
    <!-- Call Modal -->
    <div id="callModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-card rounded-2xl p-6 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">üìû Make a Call</h2>
                <button onclick="closeCallModal()" class="text-gray-500 hover:text-gray-700 text-3xl">√ó</button>
            </div>

            <div class="text-center mb-6">
                <p class="text-gray-600 mb-2">Calling <span id="callCustomerName" class="font-bold"></span></p>
                <p class="text-2xl font-bold text-gray-800 mb-4" id="callCustomerNumber"></p>
                <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200 text-sm text-yellow-800 text-left">
                    <p class="font-bold mb-1">How this works:</p>
                    1. We will call your phone number first.<br>
                    2. When you answer, we'll bridge you to the customer.<br>
                    3. The customer will see the business number.
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold mb-2">Your Phone Number</label>
                <input type="tel" id="myPhoneNumber" placeholder="+1..."
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg text-center font-mono">
                <p class="text-xs text-gray-500 mt-1 text-center">Saved for next time</p>
            </div>

            <button onclick="performCall()" id="performCallBtn"
                class="w-full px-6 py-4 bg-green-600 text-white rounded-xl font-bold text-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
                <span>üìû</span> Place Call
            </button>
        </div>
    </div>
    <script>
        // --- DEMO MODE MOCK SCRIPT ---
        (function () {
            console.log('üîß DEMO MODE ACTIVE');


            // 1. Mock Data - Generated for Bulk Testing
            const teamsList = ['North Team', 'South Team', 'East Team', 'West Team', 'Central Ops'];
            const firstNames = ['James', 'Mary', 'John', 'Patricia', 'Robert', 'Jennifer', 'Michael', 'Linda', 'William', 'Elizabeth', 'David', 'Barbara', 'Richard', 'Susan', 'Joseph', 'Jessica', 'Thomas', 'Sarah', 'Charles', 'Karen'];
            const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez'];

            let mockDrivers = [];

            // Generate 50 drivers
            for (let i = 1; i <= 50; i++) {
                const fName = firstNames[Math.floor(Math.random() * firstNames.length)];
                const lName = lastNames[Math.floor(Math.random() * lastNames.length)];
                const team = teamsList[Math.floor(Math.random() * teamsList.length)];
                mockDrivers.push({
                    id: 100 + i,
                    name: `${fName} ${lName}`,
                    firstName: fName,
                    phone: `+155501${String(i).padStart(3, '0')}`, // +155501001, etc.
                    team: team
                });
            }
            // Ensure we have our core reliable testers
            mockDrivers[0] = { id: 101, name: 'Alice Smith', firstName: 'Alice', phone: '+15550100101', team: 'North Team' };
            mockDrivers[1] = { id: 102, name: 'Bob Jones', firstName: 'Bob', phone: '+15550100102', team: 'North Team' };


            // Pre-load data if not already loaded
            if (drivers.length === 0) {
                console.log('üì• Pre-loading demo drivers...');
                drivers.length = 0;
                drivers.push(...mockDrivers);
                teams.length = 0;
                teams.push('all', 'North Team', 'South Team', 'East Team', 'West Team', 'Central Ops');
            }

            // 0. NUCLEAR OPTION: Override window.onload entirely
            // This prevents the original initialization from running and potentially loading real data
            window.onload = async () => {
                console.log('üöÄ DEMO MODE: Custom Initialization');

                // Unregister any existing Service Workers
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(function (registrations) {
                        for (let registration of registrations) {
                            console.log('üõë Unregistering Service Worker:', registration);
                            registration.unregister();
                        }
                    });
                }

                // Initialize Mock State
                loadTheme();
                initializeEmojiPicker();

                // Force Mock Data Load
                window.loadCredentials(); // Runs our mock
                window.loadCachedDrivers(); // Runs our mock
                window.loadCachedConversations(); // Runs our mock drivers

                // Fake Login Check
                const auth = sessionStorage.getItem('auth');
                if (auth) {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    updateDriverList(); // Render drivers
                } else {
                    document.getElementById('loginScreen').classList.remove('hidden');
                }

                // Start Mock Polling
                setInterval(window.pollMessages, 3000);

                console.log('‚úÖ DEMO MODE: Initialization Complete');
            };


            // 2. Mock Fetch
            const originalFetch = window.fetch;
            window.fetch = async (url, options) => {
                console.log('üì° Mock Fetch Intercepted:', url);

                // Simulate network delay
                await new Promise(r => setTimeout(r, 600));

                // /api/me (Login)
                if (url.includes('/api/me')) {
                    return new Response(JSON.stringify({
                        email: 'demo_admin',  // checkAuth() looks for data.email
                        username: 'demo_admin',
                        role: 'Admin',
                        company: 'Demo Corp'
                    }), { status: 200, headers: { 'Content-Type': 'application/json' } });
                }

                // /api/test-connection
                if (url.includes('/api/test-connection')) {
                    return new Response(JSON.stringify({
                        success: true,
                        accountName: 'Demo Account'
                    }), { status: 200 });
                }

                // /api/settings
                if (url.includes('/api/settings')) {
                    // Return proper JSON for GET requests (loadSettings expects JSON)
                    return new Response(JSON.stringify({
                        sid: 'DEMO_SID_XXXXXXX',
                        token: 'DEMO_TOKEN_HIDDEN',
                        number: '+1555DEMO000',
                        company: 'Demo Corp'
                    }), { status: 200, headers: { 'Content-Type': 'application/json' } });
                }

                // /api/send-message
                if (url.includes('/api/send-message')) {
                    const body = JSON.parse(options.body);
                    console.log('üì§ Mock Send:', body);

                    // Trigger Auto-Reply
                    setTimeout(() => {
                        triggerMockReply(body.to, body.body);
                    }, 3000 + Math.random() * 2000);

                    return new Response(JSON.stringify({
                        sid: 'SM' + Math.random().toString(36).substr(2, 9),
                        status: 'queued',
                        date_created: new Date().toISOString()
                    }), { status: 200 });
                }


                // /api/users (User List)
                if (url.includes('/api/users')) {
                    return new Response(JSON.stringify({
                        users: [
                            { username: 'demo_admin', role: 'Admin', color: '#667eea', company: 'Demo Corp' },
                            { username: 'demo_user', role: 'User', color: '#48bb78', company: 'Demo Corp' },
                            { username: 'demo_manager', role: 'Manager', color: '#ed8936', company: 'Demo Corp' }
                        ]
                    }), { status: 200 });
                }

                // /api/messages (Polling)
                if (url.includes('/api/messages')) {
                    // Check if we have any queued mock replies
                    const replies = window.mockIncomingQueue || [];
                    window.mockIncomingQueue = []; // Clear queue

                    return new Response(JSON.stringify({
                        messages: replies
                    }), { status: 200 });
                }

                return originalFetch(url, options);
            };

            // 3. Mock Reply Logic
            window.mockIncomingQueue = [];

            function triggerMockReply(phone, originalMsg) {
                const driver = drivers.find(d => d.phone === phone);
                const name = driver ? driver.firstName : 'Driver';
                let replyText = `Thanks for your message! This is an auto-reply from ${name}.`;

                if (originalMsg.toLowerCase().includes('hello') || originalMsg.toLowerCase().includes('hi')) {
                    replyText = `Hey there! How can I help you today?`;
                } else if (originalMsg.toLowerCase().includes('job')) {
                    replyText = `I'm on it! Heading to the destination now.`;
                } else if (originalMsg.toLowerCase().includes('late')) {
                    replyText = `Sorry, traffic is crazy! I'll be there in 10 mins.`;
                }

                const replyMsg = {
                    sid: 'SM' + Math.random().toString(36).substr(2, 9),
                    body: replyText,
                    from: phone,
                    to: '+1234567890', // Twilio number
                    date_created: new Date().toISOString(),
                    direction: 'inbound'
                };

                console.log('üì© Mock Reply Queued:', replyMsg);
                window.mockIncomingQueue.push(replyMsg);
            }


            // 4. Overwrite Login to allow instant access
            window.login = async function () {
                console.log('üîì Demo Login Bypass');
                const userInput = document.getElementById('usernameInput');
                const passInput = document.getElementById('passwordInput');
                const user = userInput ? userInput.value.trim() : 'demo';

                // Visual feedback
                const btn = document.querySelector('button[onclick="login()"]');
                if (btn) {
                    const originalText = btn.innerText;
                    btn.innerText = 'üîì Logging in...';
                    await new Promise(r => setTimeout(r, 500));
                    btn.innerText = originalText;
                }

                // Set authenticated state
                const auth = btoa(`${user}:demo`);
                sessionStorage.setItem('auth', auth);
                currentUser = user || 'demo_user';

                // Update UI manually (No reload)
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                // Update User details
                const userDisplay = document.getElementById('currentUserDisplay');
                if (userDisplay) userDisplay.textContent = currentUser;

                // Show admin button if needed
                if (currentUser === 'admin') {
                    const manageBtn = document.getElementById('manageUsersBtn');
                    if (manageBtn) manageBtn.classList.remove('hidden');
                }

                // Force load mock drivers
                drivers.length = 0;
                drivers.push(...mockDrivers);
                teams.length = 0;
                teams.push('all', 'North Team', 'South Team', 'East Team', 'West Team', 'Central Ops');

                // IMPORTANT: Populate team dropdown BEFORE calling updateDriverList
                // because updateDriverList reads teamSelect.value
                const teamSelect = document.getElementById('teamSelect');
                if (teamSelect) {
                    teamSelect.innerHTML = teams.map(t => {
                        const count = t === 'all' ? drivers.length : drivers.filter(d => d.team === t).length;
                        return `<option value="${t}">${t === 'all' ? 'üåç All Teams' : t} (${count})</option>`;
                    }).join('');
                    teamSelect.value = 'all'; // Ensure 'all' is selected
                }

                // Now update driver list (will correctly read teamSelect.value = 'all')
                updateDriverList();

                console.log('‚úÖ Demo Login Complete');
            };

            // 6. Force Mock Data & Disable LocalStorage
            window.loadCachedDrivers = function () {
                console.log('üõë Preventing real cache load');
                drivers.length = 0;
                drivers.push(...mockDrivers);
                teams.length = 0;
                teams.push('all', 'North Team', 'South Team', 'East Team', 'West Team', 'Central Ops');

                document.getElementById('uploadPrompt').classList.add('hidden');
                document.getElementById('mainInterface').classList.remove('hidden');

                // IMPORTANT: Populate team dropdown BEFORE calling updateDriverList
                const teamSelect = document.getElementById('teamSelect');
                if (teamSelect) {
                    teamSelect.innerHTML = teams.map(t => {
                        const count = t === 'all' ? drivers.length : drivers.filter(d => d.team === t).length;
                        return `<option value="${t}">${t === 'all' ? 'üåç All Teams' : t} (${count})</option>`;
                    }).join('');
                    teamSelect.value = 'all';
                }

                updateDriverList();
            };

            // Disable saving to avoid corrupting real app data
            window.saveCachedDrivers = () => console.log('üõë Save disabled in Demo');
            window.saveCachedConversations = () => console.log('üõë Chat save disabled in Demo');
            window.saveAdHocContacts = () => console.log('üõë Contact save disabled in Demo');

            // 7. Speed up polling for demo
            // Clear existing interval if any (hard to capture global ID, so we just start a faster one that overlaps)
            // But we can overwrite pollMessages to be instant for the demo interaction
            const originalPoll = window.pollMessages;
            setInterval(() => {
                if (document.getElementById('loginScreen').classList.contains('hidden')) {
                    originalPoll();
                }
            }, 3000); // Poll every 3 seconds instead of 15


            // 8. ISOLATION: Override Storage loading
            window.loadCredentials = function () {
                console.log('üîí Real credentials loading blocked in Demo Mode');
                // Ensure fields are empty or show dummy text
                if (document.getElementById('accountSid')) document.getElementById('accountSid').value = '';
                if (document.getElementById('authToken')) document.getElementById('authToken').value = '';
                if (document.getElementById('twilioNumber')) document.getElementById('twilioNumber').value = '';
                if (document.getElementById('companyNameSettings')) document.getElementById('companyNameSettings').value = 'Demo Corp';
                updateHeaderTitle('Demo Corp');
            };

            // 10. Force Mock Conversations
            window.loadCachedConversations = function () {
                console.log('üõë Preventing real conversation load');
                conversations = {};

                // Generated dummy history for first few drivers
                const intents = ['Hello', 'Where are you?', 'On my way', 'Traffic is bad', 'Ok thanks'];

                mockDrivers.slice(0, 5).forEach(d => {
                    conversations[d.phone] = [];
                    // Add 2-3 random messages
                    for (let i = 0; i < 3; i++) {
                        conversations[d.phone].push({
                            sid: 'SM' + Math.random().toString(36).substr(2, 9),
                            body: intents[Math.floor(Math.random() * intents.length)],
                            direction: Math.random() > 0.5 ? 'inbound' : 'outbound-api',
                            timestamp: new Date(Date.now() - Math.floor(Math.random() * 10000000)).toISOString(),
                            senderName: Math.random() > 0.5 ? 'Demo User' : undefined,
                            isBulk: false
                        });
                    }
                });
            };

            // 9. ISOLATION: Mock LocalStorage to prevent saving/deleting real data
            const originalSetItem = Storage.prototype.setItem;
            const originalRemoveItem = Storage.prototype.removeItem;
            const originalGetItem = Storage.prototype.getItem;

            Storage.prototype.setItem = function (key, value) {
                if (key === 'notificationSound') {
                    console.log('üîä (Mock) Saving sound pref:', value);
                    // We allow saving sound pref to session for this demo run only?
                    // Better to just map it to a memory object for true isolation
                    window._demoStorage = window._demoStorage || {};
                    window._demoStorage[key] = value;
                    return;
                }
                console.log('üõë LocalStorage Write Blocked:', key);
            };

            Storage.prototype.getItem = function (key) {
                if (window._demoStorage && window._demoStorage[key]) {
                    return window._demoStorage[key];
                }
                // Allow reading real settings? Maybe for theme?
                // Safer to return null for sensitive stuff
                if (['twilio_sid', 'twilio_token', 'twilio_number'].includes(key)) return null;
                return originalGetItem.call(this, key);
            };

            Storage.prototype.removeItem = function (key) {
                console.log('üõë LocalStorage Delete Blocked:', key);
            };


            // 11. Disable Service Worker
            window.registerServiceWorker = function () {
                console.log('üõë Service Worker disabled in Demo Mode');
            };

            // 12. Mock Blacklist & Ad-Hoc
            window.loadBlacklist = function () { blacklistedNumbers = new Set(); };
            window.saveBlacklist = function () { console.log('üõë Blacklist save disabled'); };
            window.loadAdHocContacts = function () { };
            window.saveAdHocContacts = function () { console.log('üõë Contact save disabled'); };

            // 5. Pre-fill login if empty

            if (document.getElementById('usernameInput')) {
                document.getElementById('usernameInput').value = 'demo';
                document.getElementById('passwordInput').value = 'demo';
            }

        })();
    </script>
</body>

</html>